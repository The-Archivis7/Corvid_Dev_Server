<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Crooms Connect</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<style>
/* ------------------------------------------------------------------- */
/* ROOT THEME VARIABLES (Default: DARK MODE)                           */
/* ----------------------------------------------------------efihvfehivegrerfgufewk2efbwqdedvjewgfrwer2ihererewfjwehiewiherilrfwfowfhrfrh;--------- */
:root {
/* Dynamic Theme Variables */
--primary-bg: #1a1b2f; /* Main App Background (Dark Blue/Gray) */
--content-bg: #2b2d42; /* Card/Section Background */
--text-color: #f8f9fa; /* Light Text Color */
--shadow: 0 4px 12px rgba(0,0,0,0.4);
--border-color: rgba(248, 249, 250, 0.1);
--card-bg-subtle: rgba(248, 249, 250, 0.05);
/* Fixed Accent Colors */
--accent-blue: #4cc9f0;
--accent-green: #80ed99;
--accent-red: #ef476f;
--accent-yellow: #ffd166;
--radius: 15px;
}

/* ------------------------------------------------------------------- */
/* LIGHT MODE OVERRIDES                                                */
/* ------------------------------------------------------------------- */
.light-mode {
--primary-bg: #f0f4f8; /* Very Light Gray/Blue */
--content-bg: #ffffff; /* White Cards */
--text-color: #000000; /* Black Text */
--shadow: 0 4px 12px rgba(0,0,0,0.15);
--border-color: rgba(26, 27, 47, 0.1);
--card-bg-subtle: #f8f9fa; /* Off-white for subtle card areas */
}
/* ------------------------------------------------------------------- */
/* BASE STYLES                                                         */
/* ------------------------------------------------------------------- */
body {
margin: 0;
font-family: "Segoe UI", Arial, sans-serif;
background: var(--primary-bg);
color: var(--text-color);
padding: 65px 280px 0 200px;
overflow-x: hidden;
transition: background-color 0.3s, color 0.3s;
}

/* SQUIGGLY BACKGROUND LINES (Adapt to current text color for visibility) */
body::before {
content: "";
position: fixed;
top: 0; left: 0;
width: 100%; height: 100%;
/* SVG stroke color references the dynamic --text-color variable */
background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><path d="M0 50 Q50 0 100 50 T200 50 V200 H0 Z" fill="none" stroke="var(--text-color, rgba(255,255,255,0.05))" stroke-width="2"/></svg>');
background-size: 200px 200px;
z-index: -1;
/* Opacity is adjusted dynamically based on theme contrast */
opacity: 0.05;
}
.light-mode::before {
opacity: 0.1; /* Make squiggles visible on light background */
}
/* HEADER */
.header {
display: flex;
justify-content: space-between;
align-items: center;
padding: 10px 15px;
/* Use a semi-transparent primary background for the header */
background: color-mix(in srgb, var(--primary-bg) 90%, transparent);
backdrop-filter: blur(10px);
box-shadow: var(--shadow);
position: fixed;
top: 0;
left: 0;
width: 100%;
z-index: 100;
transition: top 0.3s, background 0.3s;
}
.header .title-text {
font-weight: bold;
font-size: clamp(16px, 4vw, 20px);
color: var(--accent-blue);
flex-shrink: 0;
}
.header .user-id-display {
font-size: 10px;
color: var(--text-color);
opacity: 0.6;
padding-left: 10px;
max-width: 40%;
overflow: hidden;
text-overflow: ellipsis;
white-space: nowrap;
}
/* NAVIGATION BUTTONS */
.left-box {
position: fixed;
left: 0;
top: 65px;
width: 200px;
height: calc(100vh - 65px);
display: flex;
flex-direction: column;
gap: 15px;
padding: 20px;
background: var(--content-bg);
border-right: 1px solid var(--border-color);
overflow-y: auto;
}
.left-box button {
background: var(--content-bg);
color: var(--text-color);
border: 1px solid var(--border-color);
border-radius: var(--radius);
padding: 12px 20px;
cursor: pointer;
font-size: 16px;
font-weight: bold;
/* Adding a subtle glowing transition effect */
transition: 0.3s ease-in-out;
/* Subtle shadow/border effect */
box-shadow: inset 0 1px 3px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.1);
}
.left-box button:hover {
/* Using a radial gradient effect for the 'light' feel */
background: radial-gradient(circle at top left, var(--accent-blue) 10%, var(--content-bg) 100%);
color: var(--primary-bg);
transform: translateY(-3px);
/* More pronounced shadow with a subtle blue glow */
box-shadow: 0 8px 20px rgba(76, 201, 240, 0.4), 0 0 15px rgba(76, 201, 240, 0.3);
}
.left-box button.active {
/* Active state uses a strong blue gradient */
background: linear-gradient(45deg, var(--accent-blue), #2a8dff);
color: var(--primary-bg);
/* Added stronger shadow for active state */
box-shadow: 0 4px 10px rgba(76, 201, 240, 0.6);
transform: none; /* No lift when active */
}
/* TIMER STYLES (Pulse/Blink removed, replaced with color logic in JS) */
.timer-text.timer-active {
/* No animation */
display: inline-block;
font-weight: bolder;
transition: color 0.3s;
/* Default active color (will be overridden by JS for green/red) */
color: var(--accent-red); /* Placeholder color, JS overrides this for green/red based on time left */
}
/* TAB CONTENT */
.tab-content {
display: none;
animation: fadeInUp 0.7s ease;
}
.tab-content.active {
display: block;
}
/* SECTION CONTAINER (Uses Content BG) */
section, .right-box {
background: var(--content-bg);
border-radius: var(--radius);
padding: 30px;
margin: 0 auto;
max-width: 900px;
box-shadow: var(--shadow);
border: 1px solid var(--border-color);
position: relative;
overflow: hidden;
transition: all 0.3s ease;
}
/* SQUIGGLES INSIDE CARDS (Less visible) */
section::before {
content: "";
position: absolute;
top: 0; left: 0; right: 0; bottom: 0;
background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><path d="M0 100 Q50 50 100 100 T200 100 V200 H0 Z" fill="none" stroke="var(--text-color, rgba(255,255,255,0.05))" stroke-width="2"/></svg>');
background-size: 200px 200px;
opacity: 0.1;
z-index: 0;
}
section h1, section h2, section p, section .disclaimer-point {
position: relative;
z-index: 1;
}
section h1 { color: var(--accent-blue); }
section h2 { color: var(--accent-green); }
/* CARDS INSIDE SECTIONS */
.card-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 20px;
margin-top: 20px;
}
.card {
background: var(--card-bg-subtle);
border: 1px solid var(--border-color);
padding: 20px;
border-radius: var(--radius);
box-shadow: 0 2px 8px rgba(0,0,0,0.2); /* Slightly weaker card shadow */
transition: all 0.3s ease;
position: relative;
overflow: hidden;
text-align: center;
}
.card:hover {
transform: translateY(-8px) scale(1.05);
box-shadow: 0 8px 25px rgba(0,0,0,0.3);
background: linear-gradient(135deg, var(--card-bg-subtle), rgba(76, 201, 240, 0.05));
}
.card .icon {
font-size: 35px;
margin-bottom: 10px;
display: block;
}

/* TRIVIA STYLES */
.trivia-option {
background: var(--content-bg);
color: var(--text-color);
border: 1px solid var(--border-color);
border-radius: var(--radius);
padding: 10px 20px;
margin: 5px;
cursor: pointer;
transition: all 0.3s;
}
.trivia-option:hover {
background: var(--accent-blue);
color: var(--primary-bg);
}

/* POLLS STYLES */
.poll-submenu-btn {
transition: all 0.3s;
}
.poll-submenu-btn:hover {
background: var(--accent-green) !important;
}
.poll-submenu-btn.active {
background: var(--accent-red) !important;
}
.poll-option {
transition: all 0.3s;
}
.poll-option:hover {
background: var(--accent-blue) !important;
color: var(--primary-bg) !important;
}
/* RIGHT BOX */
.right-box {
position: fixed;
right: 0;
top: 65px;
width: 280px;
height: calc(100vh - 65px);
display: flex;
flex-direction: column;
gap: 15px;
padding: 20px;
background: var(--content-bg);
border-left: 1px solid var(--border-color);
overflow-y: auto;
}
.right-box h2 {
text-align: center;
color: var(--accent-yellow);
}
.right-box .section {
margin-top: 0;
background: var(--card-bg-subtle);
padding: 10px;
border-radius: var(--radius);
text-align: center;
font-weight: bold;
border: 1px solid var(--border-color);
transition: background-color 0.3s;
}
.right-box .info p {
margin: 8px 0;
cursor: pointer;
transition: color 0.2s;
}

/* FOOTER */
footer {
text-align: center;
padding: 20px;
background: var(--primary-bg);
margin-top: 40px;
color: var(--text-color);
font-size: 14px;
transition: background-color 0.3s, color 0.3s;
}
footer a {
color: var(--accent-blue);
text-decoration: none;
cursor: pointer;
}

/* THEME BUTTON STYLES (Restored Gradients/Lighting) */
.theme-button {
width: 100%;
padding: 15px;
margin-top: 10px;
font-weight: bold;
border: none;
border-radius: 10px;
cursor: pointer;
transition: transform 0.2s, opacity 0.3s, background-color 0.3s, box-shadow 0.3s;
box-shadow: 0 4px 6px rgba(0,0,0,0.2);
}
#dark-mode-button {
background-color: var(--content-bg);
color: var(--text-color);
border: 2px solid var(--accent-blue);
background-image: linear-gradient(135deg, var(--content-bg), var(--content-bg) 80%, rgba(76, 201, 240, 0.1));
}
#dark-mode-button.active, #dark-mode-button:hover {
background-image: linear-gradient(135deg, var(--accent-blue), #2a8dff); /* Blue Gradient */
color: var(--primary-bg);
transform: translateY(-2px);
box-shadow: 0 4px 15px rgba(76, 201, 240, 0.6);
}
#light-mode-button {
background-color: var(--content-bg);
color: var(--text-color);
border: 2px solid var(--accent-yellow);
background-image: linear-gradient(135deg, var(--content-bg), var(--content-bg) 80%, rgba(255, 209, 102, 0.1));
}
#light-mode-button.active, #light-mode-button:hover {
background-image: linear-gradient(135deg, var(--accent-yellow), #ffc34d); /* Yellow Gradient */
color: var(--primary-bg);
transform: translateY(-2px);
box-shadow: 0 4px 15px rgba(255, 209, 102, 0.6);
}
/* ANIMATIONS AND MODALS (Kept for completeness) */
@keyframes fadeInUp {
from {opacity: 0; transform: translateY(20px);}
to {opacity: 1; transform: translateY(0);}
}
@keyframes fadeIn {
from {opacity: 0;}
to {opacity: 1;}
}

.modal-overlay {
position: fixed; top: 0; left: 0; width: 100%; height: 100%;
background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px);
z-index: 1000; display: none; justify-content: center; align-items: center;
opacity: 0; transition: opacity 0.3s ease;
}
.modal-overlay.show { display: flex; opacity: 1; }
.modal-content {
background: var(--content-bg); border-radius: var(--radius);
padding: 40px 30px; max-width: 850px; width: 90%; max-height: 80vh;
overflow-y: auto; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
border: 2px solid var(--accent-red); position: relative;
transform: scale(0.9); transition: transform 0.3s ease, background-color 0.3s, color 0.3s, background-image 0.3s;
}
.modal-overlay.show .modal-content { transform: scale(1); }
.close-button {
position: absolute; top: 15px; right: 15px; background: none; border: none;
color: var(--text-color); font-size: 24px; cursor: pointer; line-height: 1;
padding: 5px; opacity: 0.7; transition: opacity 0.2s, color 0.2s;
}
.close-button:hover { opacity: 1; color: var(--accent-red); }

/* CALENDAR MODAL STYLES */
.calendar-grid {
display: grid;
grid-template-columns: repeat(4, 1fr);
gap: 20px;
margin-top: 20px;
}
.calendar-month {
background: var(--card-bg-subtle);
border: 1px solid var(--border-color);
border-radius: var(--radius);
padding: 10px;
text-align: center;
}
.calendar-month h3 {
color: var(--accent-blue);
margin-bottom: 10px;
font-size: 18px;
}
.calendar-month .days {
display: grid;
grid-template-columns: repeat(7, 1fr);
gap: 5px;
}
.calendar-month .day {
padding: 5px;
font-size: 14px;
border-radius: 3px;
}
.calendar-month .day.today {
background: var(--accent-yellow);
color: var(--primary-bg);
font-weight: bold;
}
.calendar-month .day.holiday {
background: var(--accent-red);
color: var(--primary-bg);
}
.calendar-month .day-header {
font-weight: bold;
color: var(--accent-green);
}

/* CALENDAR TOOLTIP STYLES */
.calendar-tooltip {
position: absolute;
background: var(--content-bg);
color: var(--text-color);
border: 1px solid var(--border-color);
border-radius: var(--radius);
padding: 8px 12px;
font-size: 14px;
font-weight: bold;
box-shadow: 0 4px 12px rgba(0,0,0,0.3);
z-index: 1001;
pointer-events: none;
display: none;
max-width: 200px;
word-wrap: break-word;
}

/* Close Tab Button */
.close-tab-button {
position: absolute;
top: 15px;
right: 15px;
background: none;
border: none;
color: var(--text-color);
font-size: 24px;
cursor: pointer;
line-height: 1;
padding: 5px;
opacity: 0.7;
transition: opacity 0.2s, color 0.2s;
z-index: 2;
}
.close-tab-button:hover {
opacity: 1;
color: var(--accent-red);
}

/* Settings Form Styles */
.settings-form {
text-align: left;
margin-top: 15px;
}
.settings-form label {
display: block;
margin-top: 10px;
margin-bottom: 5px;
font-size: 14px;
font-weight: bold;
color: var(--accent-green); /* Use accent color for label */
}
.settings-form input {
width: 100%;
padding: 8px;
border-radius: 5px;
border: 1px solid var(--border-color);
background: var(--primary-bg);
color: var(--text-color);
font-size: 14px;
transition: border-color 0.3s;
}
.settings-form input:focus {
outline: none;
border-color: var(--accent-blue);
}
.save-settings-button {
margin-top: 20px;
width: 100%;
padding: 10px;
border: none;
border-radius: 10px;
background: linear-gradient(45deg, var(--accent-green), #4CAF50);
color: var(--primary-bg);
font-weight: bold;
cursor: pointer;
transition: transform 0.2s, box-shadow 0.3s;
box-shadow: 0 4px 8px rgba(128, 237, 153, 0.4);
}
.save-settings-button:hover {
transform: translateY(-2px);
box-shadow: 0 6px 12px rgba(128, 237, 153, 0.6);
}

/* Reminder list styles */
#active-reminders-list {
list-style: none;
padding: 0;
}
#active-reminders-list li {
padding: 8px 0;
border-bottom: 1px dashed var(--border-color);
display: flex;
justify-content: space-between;
align-items: center;
font-size: 15px;
}
#active-reminders-list li:last-child {
border-bottom: none;
}

/* NEW: In-App Notification Styling for slide-in effect */
#in-app-notification {
position: fixed;
top: 20px;
right: 20px;
width: 300px;
background: var(--accent-blue);
color: var(--primary-bg);
padding: 15px;
border-radius: var(--radius);
box-shadow: 0 6px 20px rgba(0,0,0,0.5);
z-index: 1100; /* Above modals */
transform: translateX(120%); /* Start off-screen to the right */
/* Springy slide-in animation */
transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

#in-app-notification.show {
transform: translateX(0); /* Slide into view */
}

#in-app-notification h4 {
margin: 0 0 5px 0;
font-weight: bold;
font-size: 16px;
color: var(--primary-bg);
display: flex;
align-items: center;
}
#in-app-notification h4 span {
margin-right: 8px;
font-size: 20px;
}

#in-app-notification p {
margin: 0;
font-size: 14px;
}

/* NEW: Added Cropper and Avatar Preview CSS from ACcountSetings.html */
.cropper-container {
  border-radius: 9999px !important; /* fully rounded */
  overflow: hidden;
  border: 2px solid var(--border-color); /* Use theme variable */
  box-shadow: 0 3px 8px 0 rgba(0,0,0,0.07);
  margin: 0 auto;
  width: 260px;
  height: 260px;
  background: var(--primary-bg); /* Use theme variable */
}
.cropper-view-box, .cropper-face {
  border-radius: 50% !important;
}
.avatar-preview {
  width: 96px;
  height: 96px;
  border-radius: 9999px;
  border: 3px solid var(--accent-green); /* Use theme variable */
  object-fit: cover;
  margin: 0 auto;
}
.faded {
  opacity: 0.6;
}
</style>
<style>
#navbar {
    width: 250px;
    background-color: #333;
    color: white;
    height: 100vh;
    position: fixed;
    transition: width 0.3s ease;
    overflow: hidden;
}
#navbar.minimized {
    width: 60px;
}
#minimize-btn {
    background-color: #222;
    color: white;
    border: none;
    width: 100%;
    padding: 10px;
    cursor: pointer;
}
#main-content {
    margin-left: 250px;
    transition: margin-left 0.3s ease;
}
#navbar.minimized + #main-content {
    margin-left: 60px;
}
#top-bar {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    background-color: #f4f4f4;
    padding: 10px;
}
#profile-pic {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #ccc;
    cursor: pointer;
}
#logout-btn {
    padding: 10px 20px;
    background-color: #e74c3c;
    color: white;
    border: none;
    cursor: pointer;
}
</style></head>
<body id="app-body">
<div class="header">
<div class="flex items-center">
<span class="title-text">CROOMS CONNECT</span>
<span class="user-id-display" id="userIdDisplay">Local Theme Storage Active</span>
</div>
<div class="flex items-center space-x-2">
<img alt="Profile" id="header-profile-picture" src="https://api.dicebear.com/6.x/thumbs/svg?seed=Anonymous" style="width: 40px; height: 40px; border-radius: 50%; cursor: pointer; object-fit: cover; border: 2px solid var(--accent-blue);" title="View My Posts"/>
<a href="auth41.html" id="header-signin-button" onmouseout="this.style.backgroundColor='var(--accent-blue)'; this.style.transform='none';" onmouseover="this.style.backgroundColor='var(--accent-green)'; this.style.transform='translateY(-2px)';" style="display: none; background-color: var(--accent-blue); color: var(--primary-bg); font-weight: bold; padding: 8px 16px; border-radius: 10px; text-decoration: none; font-size: 14px; transition: all 0.3s;">
   SIGN IN
</a>
<button id="logout-btn" style="display: none; padding: 10px 20px; background-color: #e74c3c; color: white; border: none; cursor: pointer;">Logout</button>
</div>
</div>
<div id="announcement-bar" style="background-color: #ffcc00; color: #000; padding: 10px; text-align: center; font-weight: bold; display: none;"></div>
<div class="left-box">
<button data-tab="home">Home</button>
<button data-tab="news">News</button>
<button data-tab="study">Study Tools</button>
<button data-tab="weather">Weather</button>
<button data-tab="legal">Legal</button>
<button data-tab="community">Community</button>
<button data-tab="polls">Polls</button>
<button data-tab="games">Games</button>
<button data-tab="settings">Settings</button>
</div>
<div class="right-box">
<div class="section" id="info-section" style="color: var(--accent-yellow); font-weight: bold;">Loading current time and day type...</div>
<div class="section" id="period-timer">Loading Period Timer...</div>
<div class="section" id="current-lunch-display">Loading Lunch...</div>
<div class="info">
<p data-food="Boneless Wings">M ‚Äì Boneless Wings</p>
<p data-food="Orange Chicken">T ‚Äì Orange Chicken</p>
<p data-food="Baked Pasta">W ‚Äì Baked Pasta</p>
<p data-food="Burrito Bowl &gt;T ‚Äì Burrito Bowl&lt;/p&gt;
&lt;p data-food=" nachos"="">F ‚Äì Nachos</p>
</div>
</div>
<div class="tab-content active" id="home">
<section>
<button class="close-tab-button">√ó</button>
<h1>Welcome to Crooms Connect</h1>
<p>Your student hub with resources, schedules, and tools.</p>
<div id="welcome-message" style="background: var(--card-bg-subtle); border: 1px solid var(--border-color); border-radius: var(--radius); padding: 15px; margin-top: 20px; font-weight: bold; color: var(--accent-blue);">
  <h3>Latest Announcement</h3>
  <p id="home-announcement-text">Loading announcement...</p>
</div>
<div class="card-grid">
<div class="card" id="events-card">
<span class="icon"> üìÖ </span>
<h3>Events</h3>
<p>See what‚Äôs happening this week.</p>
</div>
</div>
</section>
</div>
<div class="tab-content" id="news">
<section>
<button class="close-tab-button">√ó</button>
<h1>News</h1>
<p>Latest campus announcements and updates.</p>
<div id="announcement-content" style="background: var(--card-bg-subtle); border: 1px solid var(--border-color); border-radius: var(--radius); padding: 20px; margin-bottom: 20px;">
<h2>Current Announcement</h2>
<p id="announcement-text">Loading announcement...</p>
</div>
<script>
const fetchAnnouncement = async () => {
  try {
    const response = await fetch('http://localhost:3000/announcement');
    const data = await response.json();
    document.getElementById('announcement-text').textContent = data.announcement || 'No current announcement.';
  } catch (error) {
    console.error('Error fetching announcement:', error);
    document.getElementById('announcement-text').textContent = 'Unable to load announcement.';
  }
};

// Fetch on page load and periodically every 30 seconds
document.addEventListener('DOMContentLoaded', () => {
  fetchAnnouncement();
  setInterval(fetchAnnouncement, 30000);
});
</script>
<div id="news-content">Loading news...</div>
</section>
</div>
<div class="tab-content" id="study">
<section>
<button class="close-tab-button">√ó</button>
<h1>Study Tools</h1>
<p>Helpful tools to keep you learning.</p>
<div class="card-grid">
<div class="card" onclick="window.open('https://quizlet.com/study-guides/upload', '_blank')"><span class="icon"> üìù </span><h3>Flashcards</h3><p>Review terms quickly.</p></div>
<div class="card" onclick="window.open('https://minitoolai.com/ai-test-generator/', '_blank')"><span class="icon"> ‚ùì </span><h3>Practice Quizzes</h3><p>Test your knowledge.</p></div>
<div class="card" id="study-timer-card"><span class="icon"> ‚è±Ô∏è </span><h3>Study Timer</h3><p>Set timers for focused study sessions.</p></div>
</div>
</section>
</div>
<div class="tab-content" id="weather">
<section>
<button class="close-tab-button">√ó</button>
<h1>Weather</h1>
<p>Current weather forecast for Florida.</p>
<div id="weather-content">Loading weather...</div>
</section>
</div>
<div class="tab-content" id="community">
<section>
<button class="close-tab-button">√ó</button>
<h1>Community</h1>
<p>Connect with classmates and teachers.</p>
<div class="card-grid">
<div class="card" id="clubs-card"><span class="icon"> üë• </span><h3>Clubs</h3><p>Find and join school clubs.</p></div>
<div class="card"><span class="icon"> üí¨ </span><h3>Forums<p><a href="connect.html">Discuss topics with peers.</a></p></h3></div>
</div>
</section>
</div>
<div class="tab-content" id="polls">
<section>
<button class="close-tab-button">√ó</button>
<h1>Community Polls</h1>
<p>Vote on important topics.</p>
<div class="space-y-6" id="polls-container">
</div>
</section>
</div>
<div class="tab-content" id="games">
<section>
<button class="close-tab-button">√ó</button>
<h1>Games</h1>
<p>Fun mini-games to enjoy during breaks.</p>
<div class="card-grid">
<div class="card" id="trivia-card"><span class="icon"> üéÆ </span><h3>Trivia</h3><p>Test your knowledge in quick rounds.</p></div>
<div class="card" id="puzzle-card"><span class="icon"> üß© </span><h3>Puzzle</h3><p>Relax and challenge your mind.</p></div>
<div class="card" onclick="window.open('https://www.nytimes.com/games/wordle/index.html', '_blank')"><span class="icon"> üèÜ </span><h3>wordle</h3><p>Guess word you are daily obligated hehe.</p></div>
<div class="card" onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLScEqgYX1gD8hl9kldzTUq5hQ_-L-sp2ME1q_6HV0hPK1GaPLA/viewform?usp=header', '_blank')"><span class="icon"> üìç </span><h3>WE Need YOU</h3><p>Are YOU a game developer? Do you wanna share your works with the world? Click here to learn more!</p></div>
<div class="card" onclick="window.open('https://the-archivis7.github.io/CC_Space/', '_blank')"><span class="icon"> üöÄ </span><h3>Space Game</h3><p>Play the game, fight the aliens. -The_Corvid (yea i made this game)</p></div>

</div>
</div>
</section>
</div>
<div class="tab-content" id="settings">
<section>
<button class="close-tab-button">√ó</button>
<h1>User Settings &amp; Customization</h1>
<p>Personalize your experience. Your selections are saved locally.</p>
<div class="card-grid">
<div class="card theme-selector-card">
<span class="icon"> üåì </span>
<h3>Appearance</h3>
<p style="margin-bottom: 20px; font-size: 14px;">Toggle between Dark and Light mode.</p>
<div class="flex flex-col space-y-4">
<button class="theme-button" id="dark-mode-button">
<span class="icon"> üåô </span> Dark Mode
</button>
<button class="theme-button" id="light-mode-button">
<span class="icon"> ‚òÄÔ∏è </span> Light Mode
</button>
</div>
<div class="p-3 mt-4 text-center rounded-lg font-medium hidden" id="messageBox" style="background-color: var(--primary-bg); color: var(--text-color);"></div>
</div>
<div class="card period-names-card">
<span class="icon"> üìö </span>
<h3>Period Names</h3>
<p style="margin-bottom: 10px; font-size: 14px;">Personalize the names of your classes.</p>
<form class="settings-form" id="period-names-form">
<button class="save-settings-button" type="submit">Save Period Names</button>
</form>
<div class="p-3 mt-4 text-center rounded-lg font-medium hidden" id="periodMessage" style="background-color: var(--primary-bg); color: var(--text-color);"></div>
</div>
<div class="card lunch-names-card">
<span class="icon"> üçî </span>
<h3>Lunch Periods</h3>
<p style="margin-bottom: 10px; font-size: 14px;">Set which lunch you have for each schedule type.</p>
<form class="settings-form" id="lunch-names-form">
<label for="lunch-5th_Period_A">5th Period Lunch (Usually A Lunch)</label>
<input id="lunch-5th_Period_A" name="5th Period A" placeholder="A Lunch" type="text" value="A Lunch"/>
<label for="lunch-5th_Period_B">5th Period Lunch (Usually B Lunch)</label>
<input id="lunch-5th_Period_B" name="5th Period B" placeholder="B Lunch" type="text" value="B Lunch"/>
<label for="lunch-Homeroom_A">Homeroom Lunch (Wednesday A Lunch)</label>
<input id="lunch-Homeroom_A" name="Homeroom A" placeholder="A Lunch" type="text" value="A Lunch"/>
<label for="lunch-Homeroom_B">Homeroom Lunch (Wednesday B Lunch)</label>
<input id="lunch-Homeroom_B" name="Homeroom B" placeholder="B Lunch" type="text" value="B Lunch"/>
<button class="save-settings-button" type="submit">Save Lunch Periods</button>
</form>
<div class="p-3 mt-4 text-center rounded-lg font-medium hidden" id="lunchMessage" style="background-color: var(--primary-bg); color: var(--text-color);"></div>
</div>
<div class="card" id="notifications-card" style="cursor: pointer;">
<span class="icon"> üîî </span>
<h3>Reminders</h3>
<p>Set up alerts for important events.</p>
<button id="test-notification-button" style="margin-top: 10px; background: var(--accent-blue); color: var(--primary-bg); border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: bold;">Test Slide-in</button>
</div>
<div class="card" id="account-card"><span class="icon"> üîë </span><h3>Account</h3><p>Privacy and security options.</p></div>
<div class="card" id="display-card" style="cursor: pointer;"><span class="icon"> ‚öôÔ∏è </span><h3>Display</h3><p>Adjust font size and layout.</p></div>
<div class="card linux-wallpapers-card">
<span class="icon"> üñºÔ∏è </span>
<h3>Linux Wallpapers</h3>
<p style="margin-bottom: 20px; font-size: 14px;">Select a Linux wallpaper to apply as background and auto-adapt UI colors.</p>
<select id="linux-wallpaper-select" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--border-color); background: var(--primary-bg); color: var(--text-color);">
<option value="">None</option>
<option value="ubuntu">Ubuntu</option>
<option value="fedora">Fedora</option>
<option value="arch">Arch Linux</option>
<option value="manjaro">Manjaro</option>
<option value="debian">Debian</option>
</select>
<div style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px;">
<button class="wallpaper-button" onclick="changeWallpaper()">Change Wallpaper</button>
<button class="wallpaper-button" onclick="applyWallpaperByDistro('ubuntu')">Ubuntu Wallpaper</button>
<button class="wallpaper-button" onclick="applyWallpaperByDistro('fedora')">Fedora Wallpaper</button>
<button class="wallpaper-button" onclick="applyWallpaperByDistro('arch')">Arch Wallpaper</button>
<button class="wallpaper-button" onclick="applyWallpaperByDistro('manjaro')">Manjaro Wallpaper</button>
<button class="wallpaper-button" onclick="applyWallpaperByDistro('debian')">Debian Wallpaper</button>
</div>
<div class="p-3 mt-4 text-center rounded-lg font-medium hidden" id="wallpaperMessage" style="background-color: var(--primary-bg); color: var(--text-color);"></div>
</div>
<div class="card sign-out-card">
<span class="icon"> üö™ </span>
<h3>Sign Out</h3>
<p style="margin-bottom: 20px; font-size: 14px;">Log out of your account.</p>
<button class="save-settings-button" id="sign-out-button" style="background: linear-gradient(45deg, var(--accent-red), #c1121f); box-shadow: 0 4px 8px rgba(239, 71, 111, 0.4);">
    Sign Out Now
</button>
</div>
</div>
</section>
</div>
<div class="tab-content" id="legal">
<section>
<button class="close-tab-button">√ó</button>
<h1>Legal Disclaimer <span style="font-size: 14px; color: var(--text-color);"> (Last Updated: November 6th, 2025)</span></h1>
<div class="disclaimer-point">
<p>Effective Date: 11/6/2025</p>

<h2>1. General Information &amp; Accuracy</h2>

<h3>0) Quick Summary (Plain Language)</h3>
<ul>
<li>Not official: This is a student-run educational/communication platform‚Äînot an official school/district site.</li>
<li>Check official sources: Always verify important dates, policies, and instructions with official school staff/publications.</li>
<li>Use responsibly: Be respectful, no harmful/illegal content, no cheating or impersonation.</li>
<li>Privacy & safety: Don‚Äôt post private information. Not for emergencies‚Äîcall 911 for urgent issues.</li>
<li>We may moderate: We can remove content and suspend access for violations.</li>
<li>‚ÄúAs is‚Äù: No warranties; you use the platform at your own risk.</li>
</ul>

<h3>1) Definitions</h3>
<p><strong>‚ÄúPlatform‚Äù / ‚ÄúCrooms Connect‚Äù</strong>: The website, app(s), pages, services, features, and content administered under the Crooms Connect name.</p>
<p><strong>‚ÄúWe‚Äù, ‚ÄúUs‚Äù, ‚ÄúOur‚Äù</strong>: Crooms Connect student developers/operators and authorized volunteers.</p>
<p><strong>‚ÄúUser(s)‚Äù</strong>: Any person who accesses or uses the Platform (students, parents/guardians, staff, guests).</p>
<p><strong>‚ÄúUser-Generated Content (UGC)‚Äù</strong>: Any content posted, uploaded, shared, or submitted by Users (text, images, links, files, media, comments).</p>
<p><strong>‚ÄúOfficial Sources‚Äù</strong>: School or district-operated publications, websites, and staff communications.</p>

<h2>2) Acceptance of Terms</h2>
<p>By accessing or using the Platform, you agree to these Terms of Use and to any supplemental policies referenced here (e.g., Code of Conduct, Privacy Notice, Community Guidelines). If you do not agree, do not use the Platform.</p>

<h2>3) Changes to Terms</h2>
<p>We may update these Terms at any time. Changes are effective when posted with the ‚ÄúLast Updated‚Äù date. Continued use after changes constitutes acceptance. For significant updates, we may provide additional notice (e.g., banner, email, in-app notice).</p>

<h2>4) Eligibility & Accounts</h2>
<p>Intended users: Students and our school community. Some features may be restricted by role.</p>
<p>Account security: Keep credentials confidential; you are responsible for activity under your account. Notify us immediately of suspected unauthorized access.</p>
<p>Accurate information: Provide true, current information and update it when it changes. We may disable accounts with false or misleading info.</p>

<h2>5) Purpose & No Professional Advice</h2>
<p>The Platform is an educational and communication tool only. It is not a source of legal, medical, mental health, safety, financial, or administrative advice. For official or critical decisions, consult authorized school staff and publications.</p>

<h2>6) General Information & Accuracy</h2>
<p>We strive for accuracy but do not warrant the accuracy, adequacy, validity, reliability, availability, or completeness of any information, including announcements, schedules, or event times. Always verify with official school channels.</p>

<h2>7) Schedules, Events & Notifications</h2>
<p>Schedules and event times are subject to change without notice.</p>
<p>Calendar entries, reminders, and notifications may be delayed, misdirected, or erroneous.</p>
<p>You are responsible for double-checking time-sensitive info with official sources.</p>

<h2>8) External Links & Third Party Services</h2>
<p>The Platform may link to third-party sites/tools (e.g., forms, video platforms). These are not controlled or endorsed by us.</p>
<p>We are not responsible for third-party content, availability, security, or privacy practices.</p>
<p>Your use of third-party services is at your own risk and subject to their terms and policies.</p>

<h2>9) ‚ÄúAS IS‚Äù and ‚ÄúAS AVAILABLE‚Äù</h2>
<p>The Platform is provided ‚ÄúAS IS‚Äù and ‚ÄúAS AVAILABLE‚Äù, with all faults and defects, without warranties of any kind (express or implied), including but not limited to merchantability, fitness for a particular purpose, non-infringement, uninterrupted operation, error-free content, or freedom from malware.</p>

<h2>10) Maintenance, Availability & Compatibility</h2>
<p>We may suspend or limit the Platform (or features) for maintenance, updates, testing, or for any reason.</p>
<p>We do not guarantee uptime or compatibility with all browsers/devices.</p>
<p>Features labeled ‚Äúbeta,‚Äù ‚Äúpreview,‚Äù or ‚Äúexperimental‚Äù may be incomplete, change without notice, or be removed.</p>

<h2>11) Accessibility</h2>
<p>We aim to promote accessibility and inclusive design. If you encounter barriers, please contact us at thearchivis7@outlook.com with details; we will make reasonable efforts to assist or provide alternatives.</p>

<h2>12) Privacy, Student Data & Safety</h2>
<p>No official records: The Platform is not an official record system or transcript repository.</p>
<p>Limit personal data: Do not post sensitive personal information (addresses, student IDs, medical info).</p>
<p>Safety & emergencies: The Platform is not for emergency reporting. In an emergency, call 911 or contact school authorities.</p>
<p>Children‚Äôs privacy: If we learn we collected children‚Äôs personal data without appropriate consent/authorization, we will delete it upon discovery.</p>
<p>Logs & analytics: We may collect basic usage analytics and logs to operate, secure, and improve the Platform.</p>

<h2>13) User-Generated Content (UGC)</h2>
<p>Responsibility: You are solely responsible for your UGC and for ensuring it complies with laws, school policies, and these Terms.</p>
<p>License: By posting UGC, you grant Crooms Connect a worldwide, non-exclusive, royalty-free license to host, reproduce, display, perform, and distribute your content on the Platform for its educational/operational purposes.</p>
<p>No confidential info: Do not post confidential, proprietary, or private information you do not have the right to share.</p>
<p>Backups: We do not guarantee backup or restoration of UGC. Maintain your own copies.</p>
<p>Review & removal: We may (but are not obligated to) monitor, moderate, edit, or remove UGC at our discretion.</p>

<h2>14) Prohibited Conduct</h2>
<p>You agree not to:</p>
<ul>
<li>Violate laws, regulations, or school/district policies (including anti-bullying, harassment, and academic integrity rules).</li>
<li>Post or share content that is unlawful, defamatory, harassing, hateful, discriminatory, sexually explicit, exploitative, or otherwise harmful.</li>
<li>Engage in cheating, plagiarism, or academic misconduct.</li>
<li>Impersonate any person or entity; misrepresent affiliation.</li>
<li>Infringe intellectual property or privacy rights.</li>
<li>Introduce viruses, malware, or attempt to bypass security; no scraping, data mining, or automated access without permission.</li>
<li>Interfere with Platform function, overload servers, or disrupt others‚Äô use.</li>
<li>Collect data about others without consent.</li>
<li>Post personally identifiable information of minors without appropriate authorization.</li>
</ul>

<h2>15) Intellectual Property (IP)</h2>
<p>Our IP: All original content, design, branding, code, and features (excluding UGC) are the exclusive property of Crooms Connect and/or its licensors.</p>
<p>Your IP: You retain ownership of your UGC, subject to the license granted above.</p>
<p>Trademarks: Names, logos, and marks used on the Platform may be protected. Do not use them without authorization.</p>

<h2>16) Feedback & Submissions</h2>
<p>If you submit feedback, suggestions, or ideas, you grant us a perpetual, worldwide, royalty-free license to use them without any obligation to you, including attribution or compensation.</p>

<h2>17) Security</h2>
<p>We employ reasonable measures to protect the Platform, but no system is perfectly secure.</p>
<p>You are responsible for safeguarding your credentials and devices.</p>
<p>Report suspected vulnerabilities or misuse to thearchivis7@outlook.com.</p>

<h2>18) Limitation of Liability</h2>
<p>To the maximum extent permitted by law, Crooms Connect, its developers, volunteers, and affiliates shall not be liable for any indirect, incidental, special, consequential, exemplary, or punitive damages; or for lost data, lost opportunities, or reputational harm arising from or related to your use of (or inability to use) the Platform. Your sole remedy is to stop using the Platform.</p>

<h2>19) Indemnification</h2>
<p>You agree to defend, indemnify, and hold harmless Crooms Connect, its developers, volunteers, and affiliates from any claims, damages, liabilities, costs, and expenses (including reasonable attorneys‚Äô fees) arising from:</p>
<ol type="a">
<li>your use of or access to the Platform;</li>
<li>your violation of these Terms or applicable laws/policies;</li>
<li>any infringement or violation of another‚Äôs rights.</li>
</ol>

<h2>20) No Endorsement / No Official Status</h2>
<p>The Platform is not an official school or district channel and may include student opinions and content.</p>
<p>Mentions of third parties, links, or products do not constitute endorsement or sponsorship.</p>

<h2>21) Termination & Suspension</h2>
<p>We may suspend or terminate your access at any time, with or without notice, for any reason including (but not limited to) violations of these Terms, security risks, or platform management needs. Upon termination, your right to use the Platform ceases immediately. Certain provisions survive termination (e.g., IP, disclaimers, limitation of liability, indemnification).</p>

<h2>22) Communication Preferences & Messaging</h2>
<p>We may send service or administrative messages (e.g., updates, policy changes, critical notices).</p>
<p>If optional messaging/SMS is offered, standard carrier rates may apply; you can opt-out when applicable.</p>
<p>You consent to receiving electronic communications; they satisfy legal requirements for ‚Äúwritten‚Äù communications where permitted.</p>

<h2>23) Classroom & Academic Integrity</h2>
<p>The Platform must not be used to gain unfair academic advantage.</p>
<p>Teachers and staff may report suspected misconduct consistent with school policies.</p>
<p>We may restrict or log access for academic integrity reviews where appropriate.</p>

<h2>24) Data Retention & Deletion</h2>
<p>We may retain logs for operational, moderation, and safety reasons for a limited period.</p>
<p>We may delete content without notice to manage storage, legal, or policy requirements.</p>
<p>Requests related to data removal should be directed to thearchivis7@outlook.com</p>

<h2>25) Accessibility to Parents/Guardians & Staff</h2>
<p>Parents/guardians may access public content.</p>
<p>Staff participation is voluntary and may be limited by role and school policy.</p>
<p>For official records or decisions, defer to official school systems.</p>

<h2>26) Export Controls & Sanctions</h2>
<p>You represent that you are not located in a country or on a list subject to comprehensive sanctions, and you will not use the Platform for prohibited purposes under applicable export/sanctions laws.</p>

<h2>27) Mobile & App Store Terms</h2>
<p>If accessed via a mobile app, your use may be subject to the app store‚Äôs terms. The app store provider is not responsible for support or legal claims. You must comply with usage rules of the app store.</p>

<h2>28) Force Majeure</h2>
<p>We are not liable for any delay or failure due to causes beyond our reasonable control, including acts of God, natural disasters, war, terrorism, labor disputes, internet outages, platform provider failures, or changes in law.</p>

<h2>29) Severability; Waiver; Assignment</h2>
<p>If any provision is found unenforceable, the remaining provisions remain in full force.</p>
<p>Our failure to enforce a provision is not a waiver of our rights.</p>
<p>You may not assign your rights or obligations without our consent; we may assign these Terms as part of a reorganization or transition.</p>

<h2>30) Entire Agreement</h2>
<p>These Terms (and any referenced policies) constitute the entire agreement between you and us regarding the Platform and supersede all prior understandings.</p>

<h2>31) Notices to Users</h2>
<p>We may provide notices via the Platform, email, or other reasonable electronic means. Please keep your contact information current.</p>

<h2>32) Community Guidelines</h2>
<ul>
<li>Be respectful and inclusive.</li>
<li>No harassment, threats, or hate speech.</li>
<li>No cheating or plagiarism.</li>
<li>Cite sources; respect IP.</li>
<li>Protect privacy.</li>
</ul>
<p>Disclaimer: Crooms Connect is a student-run educational platform provided ‚ÄúAS IS‚Äù and not an official school/district site. No warranties are made regarding accuracy or availability. Schedules and announcements may change‚Äîverify with official sources. By using this site, you agree to our Terms, including conduct rules, UGC license, moderation rights, and limitations of liability. Not for emergencies‚Äîcall 911.</p>
</div>
</section>
</div>
<div class="modal-overlay" id="reminder-modal">
<div class="modal-content">
<button class="close-button" id="close-reminder-modal-button">√ó</button>
<h1>Set New Reminder</h1>
<form class="settings-form" id="reminder-form">
<label for="reminder-title">Title</label>
<input id="reminder-title" placeholder="e.g., Study for Math Test" required="" type="text"/>
<label for="reminder-date">Date</label>
<input id="reminder-date" required="" type="date"/>
<label for="reminder-time">Time</label>
<input id="reminder-time" required="" type="time"/>
<button class="save-settings-button" style="background: linear-gradient(45deg, var(--accent-blue), #2a8dff);" type="submit">Create Reminder</button>
<div id="reminder-list-container" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px;">
<h3 style="color: var(--accent-yellow); margin-bottom: 10px;">Scheduled Reminders</h3>
<ul id="active-reminders-list"></ul>
</div>
<div class="p-3 mt-4 text-center rounded-lg font-medium hidden" id="reminder-message" style="background-color: var(--primary-bg); color: var(--text-color);"></div>
</form>
</div>
</div>
<div class="modal-overlay" id="account-modal">
<div class="modal-content">
<button class="close-button" id="close-account-modal-button">√ó</button>
<h1>Account Settings</h1>
<form class="settings-form" id="account-form">
<label for="username">Username</label>
<input id="username" placeholder="New Username" type="text"/>
<label for="password">Password</label>
<input id="password" placeholder="New Password" type="password"/>
<label style="margin-top: 20px;">Profile Picture</label>
<div class="flex flex-col items-center mb-2" id="current-avatar-section">
<img alt="Current Avatar" class="avatar-preview faded" id="current-avatar" src="" style="display:none;"/>
<p class="text-gray-400 text-sm" id="no-avatar-text" style="color: var(--text-color); opacity: 0.7;">No profile picture set</p>
</div>
<input accept="image/*" class="block w-full text-sm text-gray-500 file:mr-3 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" id="fileInput" style="color: var(--text-color);" type="file"/>
<div class="cropper-container mt-3 mb-2" id="cropper-wrapper" style="display:none; margin: 20px auto;">
<img alt="Crop Preview" id="cropper-image" style="max-width:100%;display:block;"/>
</div>
<button class="bg-blue-600 text-white px-8 py-2 rounded-full font-semibold transition hover:bg-blue-700 disabled:opacity-60 mb-1 w-full" disabled="" id="uploadBtn" style="margin-top: 15px; background-color: var(--accent-blue); color: var(--primary-bg); font-weight: bold; padding: 10px; border-radius: 10px; cursor: pointer;" type="button">Save / Upload Picture</button>
<p class="text-center text-sm mt-2 h-5" id="status" style="color: var(--text-color); height: 1.25rem;"></p>
<div class="confirmation-message" id="confirmation-message" style="display: none;"></div>
<input class="save-settings-button" id="save-changes" style="background: var(--accent-green); margin-top: 10px;" type="submit" value="Save Username/Password"/>
</form>
</div>
</div>
<div class="modal-overlay" id="display-modal">
<div class="modal-content">
<button class="close-button" id="close-display-modal-button">√ó</button>
<h1>Font &amp; Layout Settings</h1>
<div class="settings-form">
<div style="display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; align-items: flex-end;">
<div style="flex: 1 1 200px;">
<label for="font-size">Font Size:</label>
<select id="font-size">
<option value="14px">Small</option>
<option selected="" value="16px">Medium</option>
<option value="20px">Large</option>
<option value="24px">Extra Large</option>
</select>
</div>
<div style="flex: 1 1 200px;">
<label for="font-color">Font Color:</label>
<input id="font-color" type="color" value="#333333"/>
</div>
<div style="flex: 1 1 200px;">
<label for="bg-upload">Upload Background Image:</label>
<input accept="image/*" id="bg-upload" type="file"/>
</div>
<div style="flex: 1 1 200px;">
<button id="reset-display-settings" style="width: 100%; padding: 10px; font-size: 1rem; margin-top: 5px; cursor: pointer; background: var(--accent-red); color: var(--primary-bg); border: none; border-radius: 5px;">Reset Settings</button>
</div>
</div>
<div style="background: rgba(0,0,0,0.03); padding: 20px; border-radius: 8px;">
<h2>Example Section</h2>
<p>This is sample text to demonstrate font size, font color, and background customization. Use the controls above to modify the appearance.</p>
</div>
</div>
<div class="p-3 mt-4 text-center rounded-lg font-medium hidden" id="display-message" style="background-color: var(--primary-bg); color: var(--text-color);"></div>
</div>
</div>
<div class="modal-overlay" id="clubs-modal">
<div class="modal-content">
<button class="close-button" id="close-clubs-modal-button">√ó</button>
<h1>School Clubs</h1>
<div id="clubs-content">
</div>
</div>
</div>
<div class="modal-overlay" id="trivia-modal">
<div class="modal-content">
<button class="close-button" id="close-trivia-modal-button">√ó</button>
<h1>Daily Trivia</h1>
<div id="trivia-content">
</div>
</div>
</div>
<div class="modal-overlay" id="puzzle-modal">
<div class="modal-content">
<button class="close-button" id="close-puzzle-modal-button">√ó</button>
<h1>Sliding Puzzle</h1>
<div id="puzzle-content">
</div>
</div>
</div>
<div class="modal-overlay" id="calendar-modal">
<div class="modal-content">
<button class="close-button" id="close-calendar-modal-button">√ó</button>
<h1>Yearly Calendar</h1>
<div id="calendar-content">
</div>
</div>
</div>
<div class="modal-overlay" id="study-timer-modal">
<div class="modal-content">
<button class="close-button" id="close-study-timer-modal-button">√ó</button>
<h1>Study Timer</h1>
<div id="study-timer-content">
<label for="study-minutes">Set Minutes:</label>
<input id="study-minutes" max="120" min="1" type="number" value="25"/>
<br/><br/>
<button id="start-study-timer">Start</button>
<button disabled="" id="pause-study-timer">Pause</button>
<button id="reset-study-timer">Reset</button>
<br/><br/>
<div id="study-timer-display" style="font-size: 48px; text-align: center;">00:00</div>
</div>
</div>
</div>
<div class="modal-overlay" id="my-posts-modal">
<div class="modal-content">
<button class="close-button" id="close-my-posts-modal-button">√ó</button>
<h1>My Posts</h1>
<details style="margin-bottom: 20px; background: var(--card-bg-subtle); border-radius: 10px; border: 1px solid var(--border-color);">
<summary style="padding: 10px 15px; cursor: pointer; font-weight: bold; color: var(--accent-yellow);">
                Customize Appearance
            </summary>
<form class="settings-form" id="my-posts-display-form" style="padding: 0 15px 15px 15px;">
<div style="display: flex; gap: 20px; flex-wrap: wrap;">
<div style="flex: 1 1 150px;">
<label for="my-posts-bg-color">Background Color:</label>
<input id="my-posts-bg-color" style="width: 100%; height: 40px; padding: 5px;" type="color" value="#2b2d42"/>
</div>
<div style="flex: 1 1 150px;">
<label for="my-posts-font-color">Font Color:</label>
<input id="my-posts-font-color" style="width: 100%; height: 40px; padding: 5px;" type="color" value="#f8f9fa"/>
</div>
</div>
<div style="margin-top: 15px;">
<label for="my-posts-bg-image">Upload Background Image:</label>
<input accept="image/*" id="my-posts-bg-image" style="width: 100%;" type="file"/>
</div>
<button class="save-settings-button" id="my-posts-reset-display" style="background: var(--accent-red); box-shadow: 0 4px 8px rgba(239, 71, 111, 0.4); margin-top: 20px;" type="button">Reset Appearance</button>
<div class="p-3 mt-4 text-center rounded-lg font-medium hidden" id="my-posts-display-message" style="background-color: var(--primary-bg); color: var(--text-color);"></div>
</form>
</details>
<div id="my-posts-content" style="max-height: 50vh; overflow-y: auto; padding-top: 15px; border-top: 1px solid var(--border-color);">
<p>Loading your posts...</p>
</div>
</div>
</div>
<div id="in-app-notification">
<h4><span>üîî</span> Reminder Fired</h4>
<p id="notification-message">Your reminder message goes here.</p>
</div>
<footer>
<p>¬© 2025 Crooms Connect</p>
</footer>
<img id="preview"/>
<div class="calendar-tooltip" id="calendar-tooltip"></div>
<script>
// --- Supabase Client (NEW) ---
// Using Supabase CDN
const { createClient } = supabase; 
const SUPABASE_URL = 'https://jxxnfsydjrflnephmfjm.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4eG5mc3lkanJmbG5lcGhtZmptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NTA3NjUsImV4cCI6MjA3NTAyNjc2NX0.-IRbU1ER8lu7eNPoETgVQaFJ4Fp9VMowjzWfN7EZY6w';
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
let currentUser = null; // To store the user object

// --- SCHEDULE DATA ---
const defaultSchedules = {
"Monday": [
{ period: "1st Period", start: "07:20", end: "08:13" },
{ period: "2nd Period", start: "08:18", end: "09:10" },
{ period: "3rd Period", start: "09:15", end: "10:05" },
{ period: "4th Period", start: "10:10", end: "11:02" },
{ period: "5th Period A", start: "11:07", end: "11:57" }, // Class
{ period: "5th Period B", start: "11:57", end: "12:27" }, // Lunch
{ period: "6th Period", start: "12:32", end: "13:24" },
{ period: "7th Period", start: "13:29", end: "14:20" }
],
"Tuesday": [
{ period: "1st Period", start: "07:20", end: "08:13" },
{ period: "2nd Period", start: "08:18", end: "09:10" },
{ period: "3rd Period", start: "09:15", end: "10:05" },
{ period: "4th Period", start: "10:10", end: "11:02" },
{ period: "5th Period A", start: "11:07", end: "11:57" }, // Class
{ period: "5th Period B", start: "11:57", end: "12:27" }, // Lunch
{ period: "6th Period", start: "12:32", end: "13:24" },
{ period: "7th Period", start: "13:29", end: "14:20" }
],
"Wednesday": [
{ period: "2nd Period", start: "07:20", end: "08:49" },
{ period: "4th Period", start: "08:55", end: "10:21" },
{ period: "Homeroom B", start: "10:27", end: "11:17" }, // Lunch
{ period: "Homeroom A", start: "11:17", end: "11:47" }, // Class/Homeroom
{ period: "6th Period", start: "11:53", end: "13:20" }
],
"Thursday": [
{ period: "1st Period", start: "07:20", end: "08:55" },
{ period: "3rd Period", start: "09:01", end: "10:33" },
{ period: "5th Period B", start: "10:39", end: "12:11" }, // Class
{ period: "5th Period A", start: "12:11", end: "12:41" }, // Lunch
{ period: "7th Period", start: "12:47", end: "14:20" }
],
"Friday": [
{ period: "1st Period", start: "07:20", end: "08:13" },
{ period: "2nd Period", start: "08:18", end: "09:10" },
{ period: "3rd Period", start: "09:15", end: "10:05" },
{ period: "4th Period", start: "10:10", end: "11:02" },
{ period: "5th Period A", start: "11:07", end: "11:57" }, // Class
{ period: "5th Period B", start: "11:57", end: "12:27" }, // Lunch
{ period: "6th Period", start: "12:32", end: "13:24" },
{ period: "7th Period", start: "13:29", end: "14:20" }
]
};
let schedules = JSON.parse(JSON.stringify(defaultSchedules)); // Working copy of schedules

// --- CONSTANTS ---
const THEME_STORAGE_KEY = 'croomsConnectThemeMode';
const NAMES_STORAGE_KEY = 'croomsConnectPeriodNames';
const LUNCH_STORAGE_KEY = 'croomsConnectLunchNames';
const REMINDER_STORAGE_KEY = 'croomsConnectReminders';
const DISPLAY_STORAGE_KEY = 'croomsConnectDisplaySettings';
const TRIVIA_STORAGE_KEY = 'croomsConnectTrivia';
const DEFAULT_MODE = 'dark'; // Set the default to dark

// Map of period names (keys) to their default associated lunch names (values)
const DEFAULT_LUNCH_MAP = {
"5th Period B": "B Lunch", // Standard Lunch time (M, T, F)
"5th Period A": "A Lunch", // Standard Lunch time (Thur)
"Homeroom B": "B Lunch", // Wednesday Lunch time
"Homeroom A": "A Lunch" // Wednesday Lunch time
};

// --- DOM Elements ---
const appBody = document.getElementById('app-body');
const darkModeButton = document.getElementById('dark-mode-button');
const lightModeButton = document.getElementById('light-mode-button');
const messageBox = document.getElementById('messageBox');
const tabs = document.querySelectorAll(".tab-content");
const homeButton = document.querySelector(".left-box button[data-tab='home']");
const periodNamesForm = document.getElementById('period-names-form');
const periodMessageBox = document.getElementById('periodMessage');
const lunchNamesForm = document.getElementById('lunch-names-form');
const lunchMessageBox = document.getElementById('lunchMessage');
const currentLunchDisplay = document.getElementById('current-lunch-display');
const notificationsCard = document.getElementById('notifications-card');
const reminderModal = document.getElementById('reminder-modal');
const reminderForm = document.getElementById('reminder-form');
const reminderMessageBox = document.getElementById('reminder-message');
const activeRemindersList = document.getElementById('active-reminders-list');
const closeReminderModalButton = document.getElementById('close-reminder-modal-button');
const inAppNotification = document.getElementById('in-app-notification');
const testNotificationButton = document.getElementById('test-notification-button'); // NEW
const accountCard = document.getElementById('account-card');
const accountModal = document.getElementById('account-modal');
const accountForm = document.getElementById('account-form');
const closeAccountModalButton = document.getElementById('close-account-modal-button');
const confirmationMessage = document.getElementById('confirmation-message');
const displayCard = document.getElementById('display-card');
const displayModal = document.getElementById('display-modal');
const closeDisplayModalButton = document.getElementById('close-display-modal-button');
const resetDisplayButton = document.getElementById('reset-display-settings');
const clubsCard = document.getElementById('clubs-card');
const clubsModal = document.getElementById('clubs-modal');
const closeClubsModalButton = document.getElementById('close-clubs-modal-button');
const triviaCard = document.getElementById('trivia-card');
const triviaModal = document.getElementById('trivia-modal');
const closeTriviaModalButton = document.getElementById('close-trivia-modal-button');
const puzzleCard = document.getElementById('puzzle-card');
const puzzleModal = document.getElementById('puzzle-modal');
const closePuzzleModalButton = document.getElementById('close-puzzle-modal-button');
const calendarModal = document.getElementById('calendar-modal');
const closeCalendarModalButton = document.getElementById('close-calendar-modal-button');
const eventsCard = document.getElementById('events-card');
const studyTimerCard = document.getElementById('study-timer-card');
const studyTimerModal = document.getElementById('study-timer-modal');
const closeStudyTimerModalButton = document.getElementById('close-study-timer-modal-button');
const startStudyTimerButton = document.getElementById('start-study-timer');
const pauseStudyTimerButton = document.getElementById('pause-study-timer');
const resetStudyTimerButton = document.getElementById('reset-study-timer');
const studyTimerDisplay = document.getElementById('study-timer-display');
const studyMinutesInput = document.getElementById('study-minutes');

// --- NEW DOM Elements for Auth/Posts ---
const headerProfilePicture = document.getElementById('header-profile-picture');
const headerSignInButton = document.getElementById('header-signin-button'); // <-- ADDED
const myPostsModal = document.getElementById('my-posts-modal');
const closeMyPostsModalButton = document.getElementById('close-my-posts-modal-button');
const myPostsContent = document.getElementById('my-posts-content');

// --- NEW DOM Elements for "My Posts" Customization (Supabase) ---
const myPostsModalContent = myPostsModal.querySelector('.modal-content');
const myPostsBgColorInput = document.getElementById('my-posts-bg-color');
const myPostsFontColorInput = document.getElementById('my-posts-font-color');
const myPostsBgImageInput = document.getElementById('my-posts-bg-image');
const myPostsResetButton = document.getElementById('my-posts-reset-display');
const myPostsDisplayMessage = document.getElementById('my-posts-display-message');


// --- NEW: Profile Picture Uploader Vars ---
let cropper = null;
let oldAvatarPath = null;
// These DOM elements will be selected when the modal is opened
let fileInput, cropperWrapper, cropperImg, uploadBtn, currentAvatar, noAvatarText, status;


// --- MODIFIED AUTH FUNCTION ---
async function loadUserSession() {
    const { data: authData, error: authErr } = await supabaseClient.auth.getUser();

    if (!authData?.user) {
        console.log("No user logged in. Showing Sign In button.");
        headerProfilePicture.style.display = 'none'; // <-- HIDE PIC
        if (headerSignInButton) headerSignInButton.style.display = 'block'; // <-- SHOW BUTTON
        document.getElementById('userIdDisplay').textContent = "Not Logged In";
        currentUser = null;
        return;
    }

    // User is logged in
    headerProfilePicture.style.display = 'block'; // <-- SHOW PIC
    if (headerSignInButton) headerSignInButton.style.display = 'none'; // <-- HIDE BUTTON

    currentUser = authData.user; // Store user globally
    const userId = authData.user.id;
    const { data: profile } = await supabaseClient
        .from("profiles")
        .select("username")
        .eq("id", userId)
        .single();

    const currentUsername = (profile?.username || "Anonymous").replace(/@croomsconnect\.local$/i, '');
    const customAvatar = authData.user.user_metadata?.avatar_url;

    headerProfilePicture.src = customAvatar && customAvatar.trim() !== ""
        ? customAvatar
        : `https://api.dicebear.com/6.x/thumbs/svg?seed=${encodeURIComponent(currentUsername)}`;
    
    document.getElementById('userIdDisplay').textContent = `Logged in as: ${currentUsername}`;
}

// --- NEW: Sign Out Function ---
async function handleSignOut() {
    const { error } = await supabaseClient.auth.signOut();
    if (error) {
        console.error('Error signing out:', error.message);
        alert('Error signing out: ' + error.message);
    } else {
        // Sign-out was successful, reload the page to reset state
        window.location.reload(); 
    }
}


// --- NEW "MY POSTS" DISPLAY SETTINGS FUNCTIONS (Supabase) ---
const applyMyPostsDisplaySettings = (settings) => {
    myPostsModalContent.style.backgroundColor = settings.bg_color || '';
    myPostsModalContent.style.color = settings.font_color || '';

    if (settings.bg_image_url) {
        myPostsModalContent.style.backgroundImage = `url(${settings.bg_image_url})`;
        myPostsModalContent.style.backgroundSize = 'cover';
        myPostsModalContent.style.backgroundPosition = 'center';
    } else {
        myPostsModalContent.style.backgroundImage = '';
    }
};

const saveMyPostsDisplaySettings = async (settings) => {
    if (!currentUser) return;

    const { error } = await supabaseClient
        .from('user_post_styles')
        .upsert({ 
            id: currentUser.id, 
            ...settings,
            updated_at: new Date() 
        });

    if (error) {
        console.error('Error saving settings:', error);
        showMessageBox(myPostsDisplayMessage, `Error: ${error.message}`, 'error');
    } else {
        showMessageBox(myPostsDisplayMessage, 'Appearance updated!', 'success');
        const { data } = await supabaseClient.from('user_post_styles').select().single();
        if(data) applyMyPostsDisplaySettings(data);
    }
};

const resetMyPostsDisplaySettings = async () => {
    if (!currentUser) return;

    // First delete the record from Supabase
    const { error } = await supabaseClient
        .from('user_post_styles')
        .delete()
        .eq('id', currentUser.id);

    if (error) {
        console.error('Error resetting settings:', error);
        showMessageBox(myPostsDisplayMessage, `Error: ${error.message}`, 'error');
        return;
    }

    // Then apply empty settings to clear styles
    applyMyPostsDisplaySettings({});
    
    // Reset form inputs to default
    myPostsBgColorInput.value = '#2b2d42';
    myPostsFontColorInput.value = '#f8f9fa';
    myPostsBgImageInput.value = '';
    
    showMessageBox(myPostsDisplayMessage, 'Appearance settings reset!', 'success');
};


// --- MODIFIED "MY POSTS" MODAL FUNCTIONS (Supabase) ---
const showMyPostsModal = async () => {
    if (!currentUser) {
        // This should not be reachable if the button is hidden, but as a fallback:
        alert("Please log in to see your posts.");
        return;
    }
    
    // --- Load and apply custom display settings from Supabase ---
    const { data: settings, error: settingsError } = await supabaseClient
        .from('user_post_styles')
        .select('*')
        .eq('id', currentUser.id)
        .single();

    if (settings) {
        applyMyPostsDisplaySettings(settings);
        // Set form inputs to reflect saved settings or defaults
        myPostsBgColorInput.value = settings.bg_color || '#2b2d42';
        myPostsFontColorInput.value = settings.font_color || '#f8f9fa';
    } else {
         // Apply default styles if no settings found
        applyMyPostsDisplaySettings({});
        myPostsBgColorInput.value = '#2b2d42';
        myPostsFontColorInput.value = '#f8f9fa';
    }
     myPostsBgImageInput.value = ''; // Always clear file input
    

    myPostsContent.innerHTML = "<p>Loading your posts...</p>";
    myPostsModal.classList.add('show');
    document.body.style.overflow = 'hidden';

    const { data: messages, error } = await supabaseClient
        .from('messages')
        .select('message, timestamp')
        .eq('user_id', currentUser.id)
        .order('timestamp', { ascending: false })
        .limit(50);

    if (error) {
        myPostsContent.innerHTML = `<p style="color: var(--accent-red);">Error loading posts: ${error.message}</p>`;
        return;
    }

    if (!messages || messages.length === 0) {
        myPostsContent.innerHTML = "<p>You haven't posted anything yet.</p>";
        return;
    }

    let html = '';
    messages.forEach(msg => {
        const postDate = new Date(msg.timestamp).toLocaleString();
        html += `
            <div style="background: var(--card-bg-subtle); border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; margin-bottom: 10px; word-wrap: break-word;">
                <div style="font-size: 0.85rem; color: var(--accent-yellow); margin-bottom: 5px;">${postDate}</div>
                <div>${msg.message}</div> 
            </div>
        `;
    });
    myPostsContent.innerHTML = html;
};

const hideMyPostsModal = () => {
    myPostsModal.classList.remove('show');
    document.body.style.overflow = '';
    applyMyPostsDisplaySettings({}); 
    myPostsDisplayMessage.classList.add('hidden');
};

// --- STUDY TIMER STATE VARIABLES ---
let studyTimerInterval = null;
let studyTimeLeft = 0;

// Study Timer Functions
function updateStudyTimerDisplay() {
  const minutes = Math.floor(studyTimeLeft / 60);
  const seconds = studyTimeLeft % 60;
  studyTimerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function startStudyTimer() {
  const minutes = parseInt(studyMinutesInput.value) || 25;
  studyTimeLeft = minutes * 60;
  updateStudyTimerDisplay();
  if (studyTimerInterval) clearInterval(studyTimerInterval);
  studyTimerInterval = setInterval(() => {
    studyTimeLeft--;
    updateStudyTimerDisplay();
    if (studyTimeLeft <= 0) {
      clearInterval(studyTimerInterval);
      studyTimerInterval = null;
      alert("Time's up! Take a break.");
      studyTimeLeft = 0;
      updateStudyTimerDisplay();
      startStudyTimerButton.disabled = false;
      pauseStudyTimerButton.disabled = true;
      resetStudyTimerButton.disabled = true;
    }
  }, 1000);
  startStudyTimerButton.disabled = true;
  pauseStudyTimerButton.disabled = false;
  resetStudyTimerButton.disabled = false;
}

function pauseStudyTimer() {
  if (studyTimerInterval) {
    clearInterval(studyTimerInterval);
    studyTimerInterval = null;
  }
  startStudyTimerButton.disabled = false;
  pauseStudyTimerButton.disabled = true;
}

function resetStudyTimer() {
  if (studyTimerInterval) {
    clearInterval(studyTimerInterval);
    studyTimerInterval = null;
  }
  studyTimeLeft = 0;
  updateStudyTimerDisplay();
  startStudyTimerButton.disabled = false;
  pauseStudyTimerButton.disabled = true;
  resetStudyTimerButton.disabled = true;
}

const showStudyTimerModal = () => {
  studyTimerModal.classList.add('show');
  document.body.style.overflow = 'hidden';
};

const hideStudyTimerModal = () => {
  studyTimerModal.classList.remove('show');
  document.body.style.overflow = '';
  pauseStudyTimer();
};

// Sample events data
const events = [
{ date: '2025-01-01', title: 'New Year\'s Day' },
{ date: '2025-01-20', title: 'Martin Luther King Jr. Day' },
{ date: '2025-02-14', title: 'Valentine\'s Day' },
{ date: '2025-02-17', title: 'Presidents\' Day' },
{ date: '2025-03-17', title: 'St. Patrick\'s Day' },
{ date: '2025-04-01', title: 'April Fools\' Day' },
{ date: '2025-05-26', title: 'Memorial Day' },
{ date: '2025-07-04', title: 'Independence Day' },
{ date: '2025-09-01', title: 'Labor Day' },
{ date: '2025-10-31', title: 'Halloween' },
{ date: '2025-10-14', title: 'PSAT/SAT Q2 starts' },
{ date: '2025-11-27', title: 'Thanksgiving' },
{ date: '2025-12-18', title: 'End of Q2' }
];

// --- PUZZLE CONSTANTS ---
const PUZZLE_LEVELS = [3, 4, 5]; // Grid sizes: 3x3, 4x4, 5x5

// --- PUZZLE STATE VARIABLES ---
let currentPuzzleLevel = 3;
let puzzleGrid = [];
let emptyTile = { row: 2, col: 2 }; // For 3x3, starts at bottom-right

const clubsData = [
{ name: "Amine Club", description: "Meets in 1-201", meetingDay: "Monday", time: "2:30 PM - 4:00 PM" },
{ name: "Art Club", description: "Meets in 1-114", meetingDay: "Tuesday", time: "2:30 PM - 3:30 PM" },
{ name: "Board Game Club", description: "Meets in 1-113", meetingDay: "Wednesday", time: "2:30 PM - 3:45 PM" },
{ name: "Book Club", description: "Meets in 1-115", meetingDay: "Every first Monday of every month", time: "2:30 PM - 4:00 PM" },
{ name: "Chem Lab Crew", description: "Meets in 1-221", meetingDay: "Thursday", time: "2:30 PM - 3:45 PM" },
{ name: "Chess Club", description: "Meets in 2-111", meetingDay: "Monday", time: "2:30 PM - 3:30 PM" },
{ name: "Club SWAG", description: "Meets in 1-211", meetingDay: "Wednesday", time: "After school" },
{ name: "Cinema Club", description: "Meets in 1-209", meetingDay: "Friday", time: "2:30 PM - 4:30 PM" },
{ name: "Computer Science", description: "Meets in 1-224", meetingDay: "Tuesday", time: "2:30 PM - 3:30 PM" },
{ name: "DnD Club", description: "Meets in 1-132", meetingDay: "Mondays", time: "2:30 PM - 4:30 PM" },
{ name: "eSports", description: "Meets in 1-212", meetingDay: "Fridays", time: "2:30 PM - 4:00 PM" },
{ name: "H.E.A.L", description: "Meets in 1-126", meetingDay: "Twice a month", time: "2:40 PM - 4:00 PM" },
{ name: "Paleontology Club", description: "Meets in 1-232", meetingDay: "Tuesdays", time: "2:30 PM - 3:30 PM" },
{ name: "Pride Panthers", description: "Meets in 1-113", meetingDay: "Fridays", time: "2:20 PM - 3:45 PM" },
{ name: "Robotics", description: "Meets in 1-113", meetingDay: "Thursday", time: "2:30 PM - 4:00 PM" },
{ name: "Spanish Club", description: "Meets in 1-209", meetingDay: "Friday", time: "" }
];

// --- POLLS DATA ---
const pollsData = [
{
id: 'daily-poll',
title: 'Community Daily Poll',
question: 'What is your favorite school lunch?',
options: ['Boneless Wings', 'Orange Chicken', 'Baked Pasta', 'Burrito Bowl', 'Nachos']
},
{
id: 'event-poll',
title: 'Event Poll',
question: 'Which event would you like to attend?',
options: ['School Dance', 'Sports Game', 'Club Fair', 'Talent Show', 'Movie Night']
},
{
id: 'feedback-poll',
title: 'Feedback Poll',
question: 'How do you rate the school website?',
options: ['Excellent', 'Good', 'Average', 'Poor', 'Very Poor']
}
];

const newsData = [
{ title: "update 5.0 soon", description: "in a few days our largest update of 5.0 will come soon being new games remastering puzzle game better weather system and more custom features!", link: "https://onlnbrd.com/b/CQffnwjW" },
{ title: "Student Art Exhibition This Weekend", description: "Showcase of student artwork in the main hall.", link: "https://example.com/news2" },
{ title: "New Cafeteria Menu Options", description: "Introducing healthier and diverse meal choices.", link: "https://example.com/news3" }
];

const renderNews = () => {
let html = '<h2>Latest News</h2><ul>';
newsData.forEach(news => {
html += `<li><strong><a href="${news.link}" target="_blank">${news.title}</a></strong>: ${news.description}</li>`;
});
html += '</ul>';
document.getElementById('news-content').innerHTML = html;
};

const renderClubs = () => {
let html = '<h2>Club List</h2><ul>';
clubsData.forEach(club => {
html += `<li><strong>${club.name}</strong>: ${club.description} - Meets ${club.meetingDay} at ${club.time}</li>`;
});
html += '</ul>';
html += '<h2>Weekly Calendar</h2><p>Club meetings are scheduled as follows:</p><ul>';
const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
days.forEach(day => {
const dayClubs = clubsData.filter(c => c.meetingDay === day);
if (dayClubs.length > 0) {
html += `<li><strong>${day}</strong>: ${dayClubs.map(c => `${c.name} (${c.time})`).join(', ')}</li>`;
} else {
html += `<li><strong>${day}</strong>: No club meetings</li>`;
}
});
html += '</ul>';
document.getElementById('clubs-content').innerHTML = html;
};

const showClubsModal = () => {
renderClubs();
clubsModal.classList.add('show');
document.body.style.overflow = 'hidden';
};

const hideClubsModal = () => {
clubsModal.classList.remove('show');
document.body.style.overflow = '';
};

// --- TRIVIA UTILITIES ---

const fetchTrivia = async () => {
const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
const key = `trivia-${today}`;
let stored = localStorage.getItem(TRIVIA_STORAGE_KEY);
if (stored) {
stored = JSON.parse(stored);
if (stored.date === today) {
return stored;
}
}
// Fetch new
try {
const response = await fetch('https://opentdb.com/api.php?amount=1&type=multiple');
const data = await response.json();
const question = data.results[0];
const options = [...question.incorrect_answers, question.correct_answer];
const shuffled = options.sort(() => Math.random() - 0.5);
const trivia = {
date: today,
question: question.question,
options: shuffled,
correct: question.correct_answer,
answered: false,
selected: null
};
localStorage.setItem(TRIVIA_STORAGE_KEY, JSON.stringify(trivia));
return trivia;
} catch (e) {
console.error('Error fetching trivia:', e);
return null;
}
};

const renderTrivia = (trivia) => {
if (!trivia) {
document.getElementById('trivia-content').innerHTML = '<p>Unable to load trivia. Try again later.</p>';
return;
}
let html = `<h3>${trivia.question}</h3>`;
if (trivia.answered) {
html += '<p>You have already answered today\'s trivia.</p>';
html += `<p>Your answer: ${trivia.selected}</p>`;
html += `<p>Correct answer: ${trivia.correct}</p>`;
html += `<p>${trivia.selected === trivia.correct ? 'Correct!' : 'Incorrect.'}</p>`;
} else {
html += '<div id="options">';
trivia.options.forEach((option, index) => {
html += `<button class="trivia-option" data-option="${option}">${option}</button>`;
});
html += '</div>';
}
document.getElementById('trivia-content').innerHTML = html;

// Add listeners for options
document.querySelectorAll('.trivia-option').forEach(btn => {
btn.addEventListener('click', (e) => {
const selected = e.target.getAttribute('data-option');
trivia.selected = selected;
trivia.answered = true;
localStorage.setItem(TRIVIA_STORAGE_KEY, JSON.stringify(trivia));
renderTrivia(trivia);
});
});
};

const showTriviaModal = async () => {
const trivia = await fetchTrivia();
renderTrivia(trivia);
triviaModal.classList.add('show');
document.body.style.overflow = 'hidden';
};

const hideTriviaModal = () => {
triviaModal.classList.remove('show');
document.body.style.overflow = '';
};

// --- PUZZLE UTILITIES ---

const generatePuzzle = (level) => {
const size = level;
const totalTiles = size * size;
const grid = [];
let number = 1;
for (let row = 0; row < size; row++) {
grid[row] = [];
for (let col = 0; col < size; col++) {
if (row === size - 1 && col === size - 1) {
grid[row][col] = null; // Empty tile
} else {
grid[row][col] = number++;
}
}
}
// Simple shuffle: swap random tiles
for (let i = 0; i < 1000; i++) {
const r1 = Math.floor(Math.random() * size);
const c1 = Math.floor(Math.random() * size);
const r2 = Math.floor(Math.random() * size);
const c2 = Math.floor(Math.random() * size);
[grid[r1][c1], grid[r2][c2]] = [grid[r2][c2], grid[r1][c1]];
}
// Find empty tile position
for (let row = 0; row < size; row++) {
for (let col = 0; col < size; col++) {
if (grid[row][col] === null) {
emptyTile = { row, col };
}
}
}
return grid;
};

const renderPuzzle = () => {
const size = currentPuzzleLevel;
const grid = puzzleGrid;
let html = '<div style="text-align: center; margin-bottom: 20px;">';
html += '<h3>Level: ' + size + 'x' + size + '</h3>';
html += '<div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;">';
PUZZLE_LEVELS.forEach(level => {
html += `<button class="puzzle-level-btn" data-level="${level}" style="padding: 10px 15px; background: var(--accent-blue); color: var(--primary-bg); border: none; border-radius: 5px; cursor: pointer;">${level}x${level}</button>`;
});
html += '</div>';
html += '<div class="puzzle-grid" style="display: inline-block; border: 2px solid var(--border-color);">';
for (let row = 0; row < size; row++) {
for (let col = 0; col < size; col++) {
const tile = grid[row][col];
const isEmpty = tile === null;
html += `<div class="puzzle-tile ${isEmpty ? 'empty' : ''}" data-row="${row}" data-col="${col}" style="width: 60px; height: 60px; display: inline-block; border: 1px solid var(--border-color); background: ${isEmpty ? 'var(--card-bg-subtle)' : 'var(--accent-blue)'}; color: var(--primary-bg); font-size: 24px; font-weight: bold; cursor: pointer; text-align: center; line-height: 60px; margin: 0; vertical-align: top;">${isEmpty ? '' : tile}</div>`;
}
html += '<br>';
}
html += '</div>';
html += '<p id="puzzle-status" style="margin-top: 20px; font-weight: bold;">Move the tiles to solve the puzzle!</p>';
html += '</div>';
document.getElementById('puzzle-content').innerHTML = html;

// Add listeners for level buttons
document.querySelectorAll('.puzzle-level-btn').forEach(btn => {
btn.addEventListener('click', (e) => {
const level = parseInt(e.target.getAttribute('data-level'));
currentPuzzleLevel = level;
puzzleGrid = generatePuzzle(level);
renderPuzzle();
});
});

// Add listeners for tiles
document.querySelectorAll('.puzzle-tile:not(.empty)').forEach(tile => {
tile.addEventListener('click', (e) => {
const row = parseInt(e.target.getAttribute('data-row'));
const col = parseInt(e.target.getAttribute('data-col'));
moveTile(row, col);
});
});
};

const moveTile = (row, col) => {
const size = currentPuzzleLevel;
const grid = puzzleGrid;
const empty = emptyTile;
// Check if adjacent
const dr = Math.abs(row - empty.row);
const dc = Math.abs(col - empty.col);
if ((dr === 1 && dc === 0) || (dr === 0 && dc === 1)) {
// Swap
[grid[empty.row][empty.col], grid[row][col]] = [grid[row][col], grid[empty.row][empty.col]];
emptyTile = { row, col };
renderPuzzle();
if (checkWin()) {
document.getElementById('puzzle-status').textContent = 'Congratulations! Puzzle solved!';
}
}
};

const checkWin = () => {
const size = currentPuzzleLevel;
const grid = puzzleGrid;
let number = 1;
for (let row = 0; row < size; row++) {
for (let col = 0; col < size; col++) {
if (row === size - 1 && col === size - 1) {
if (grid[row][col] !== null) return false;
} else {
if (grid[row][col] !== number++) return false;
}
}
}
return true;
};

const showPuzzleModal = () => {
puzzleGrid = generatePuzzle(currentPuzzleLevel);
renderPuzzle();
puzzleModal.classList.add('show');
document.body.style.overflow = 'hidden';
};

const hidePuzzleModal = () => {
puzzleModal.classList.remove('show');
document.body.style.overflow = '';
};
const showCalendarModal = () => {
renderCalendar();
calendarModal.classList.add('show');
document.body.style.overflow = 'hidden';
};
const hideCalendarModal = () => {
calendarModal.classList.remove('show');
document.body.style.overflow = '';
};
const renderCalendar = () => {
const html = `<h2>School Calendar</h2>
<iframe src="https://calendar.google.com/calendar/embed?height=600&wkst=1&ctz=America%2FNew_York&showPrint=0&src=Y180YjI1NDNkNTJkNTY5YzllNjVmZTcxMDFiZDc4OTkxNTdhODdmMDE2MWYzZjRkZGM1OWIzYzEzMzc1NDQ0NjY1QGdyb3VwLmNhbGVuZGFyLmdvb2dsZS5jb20&src=ZW4udXNhI2hvbGlkYXlAZ3JvdXAudi5jYWxlbmRhci5nb29nbGUuY29t&color=%237cb342&color=%230b8043" style="border:solid 1px #777" width="800" height="600" frameborder="0" scrolling="no"></iframe>`;
document.getElementById('calendar-content').innerHTML = html;
};

// --- WEATHER UTILITIES ---

const fetchWeather = async () => {
try {
const response = await fetch('https://wttr.in/Orlando?format=j1');
const data = await response.json();
const current = data.current_condition[0];
const temp = current.temp_F;
const condition = current.weatherDesc[0].value;
const feels = current.FeelsLikeF;
const humidity = current.humidity;
const wind = current.windspeedMiles;
document.getElementById('weather-content').innerHTML = `
<div class="card-grid">
<div class="card">
<span class="icon">üå§Ô∏è</span>
<h3>Current Weather in Florida</h3>
<p><strong>Temperature:</strong> ${temp}¬∞F</p>
<p><strong>Condition:</strong> ${condition}</p>
<p><strong>Feels Like:</strong> ${feels}¬∞F</p>
<p><strong>Humidity:</strong> ${humidity}%</p>
<p><strong>Wind Speed:</strong> ${wind} mph</p>
</div>
</div>
`;
} catch (e) {
document.getElementById('weather-content').innerHTML = '<p>Unable to load weather. Please try again later.</p>';
}
};

// --- DISPLAY SETTINGS UTILITIES ---

const loadDisplaySettings = () => {
try {
const settings = JSON.parse(localStorage.getItem(DISPLAY_STORAGE_KEY)) || {};
return settings;
} catch (e) {
return {};
}
};

const saveDisplaySettings = (settings) => {
try {
localStorage.setItem(DISPLAY_STORAGE_KEY, JSON.stringify(settings));
} catch (e) {
console.error("Error saving display settings:", e);
}
};

const applyDisplaySettings = (settings) => {
    const fontSize = settings.fontSize || '16px';
    const fontColor = settings.fontColor || '#f8f9fa';
    const bgImage = settings.bgImage || '';
    const wallpaperUrl = settings.wallpaperUrl || '';
    document.body.style.fontSize = fontSize;
    document.body.style.color = fontColor;
    if (wallpaperUrl) {
        document.body.style.backgroundImage = `url('${wallpaperUrl}')`;
        document.body.style.backgroundSize = 'cover';
        document.body.style.backgroundPosition = 'center';
        document.body.style.backgroundRepeat = 'no-repeat';
        document.body.style.backgroundAttachment = 'fixed';
    } else if (bgImage) {
        document.body.style.backgroundImage = `url(${bgImage})`;
        document.body.style.backgroundSize = 'cover';
        document.body.style.backgroundPosition = 'center';
        document.body.style.backgroundRepeat = 'no-repeat';
        document.body.style.backgroundAttachment = 'fixed';
    } else {
        document.body.style.backgroundImage = '';
    }
};

const resetDisplaySettings = () => {
localStorage.removeItem(DISPLAY_STORAGE_KEY);
applyDisplaySettings({});
document.getElementById('font-size').value = '16px';
document.getElementById('font-color').value = '#f8f9fa';
document.getElementById('bg-upload').value = '';
showMessageBox(document.getElementById('display-message'), 'Display settings reset!', 'success');
};

// --- GENERAL UTILITIES ---
const applyMode = (mode) => {
if (mode === 'light') {
appBody.classList.add('light-mode');
} else {
appBody.classList.remove('light-mode');
}
updateActiveButton(mode);
};

const updateActiveButton = (mode) => {
darkModeButton.classList.remove('active');
lightModeButton.classList.remove('active');

if (mode === 'dark') {
darkModeButton.classList.add('active');
} else {
lightModeButton.classList.add('active');
}
};

const saveModePreference = (mode) => {
try {
localStorage.setItem(THEME_STORAGE_KEY, mode);
applyMode(mode);
showMessageBox(messageBox, `${mode.charAt(0).toUpperCase() + mode.slice(1)} Mode activated and saved!`, 'success');
} catch (error) {
console.error("Error saving mode preference to localStorage:", error);
showMessageBox(messageBox, "Failed to save mode locally.", 'error');
}
};

const loadModePreference = () => {
try {
const savedMode = localStorage.getItem(THEME_STORAGE_KEY);
applyMode(savedMode || DEFAULT_MODE);
} catch (error) {
console.error("Error loading mode preference from localStorage:", error);
applyMode(DEFAULT_MODE);
}
};

const showMessageBox = (box, message, type) => {
box.textContent = message;
box.classList.remove('hidden');
box.style.backgroundColor = type === 'success' ? 'var(--accent-green)' : 'var(--accent-red)';
box.style.color = 'var(--primary-bg)';

setTimeout(() => box.classList.add('hidden'), 3000);
};

// --- PERIOD NAME UTILITIES ---

const getUniquePeriodKeys = () => {
const keys = new Set();
for (const day in defaultSchedules) {
defaultSchedules[day].forEach(block => keys.add(block.period));
}
return Array.from(keys).filter(key => !DEFAULT_LUNCH_MAP.hasOwnProperty(key));
};

const loadPeriodNames = () => {
try {
const savedNames = localStorage.getItem(NAMES_STORAGE_KEY);
if (savedNames) {
const customNames = JSON.parse(savedNames);
for (const day in schedules) {
schedules[day] = defaultSchedules[day].map(block => {
const originalKey = block.period;
const customName = customNames[originalKey];
if (customName) {
return { ...block, period: customName };
}
return block;
});
}
}
} catch (error) {
console.error("Error loading period names from localStorage:", error);
}
};

const populatePeriodForm = () => {
const uniqueKeys = getUniquePeriodKeys();
let savedNames = {};
try {
const savedNamesStr = localStorage.getItem(NAMES_STORAGE_KEY);
if (savedNamesStr) {
savedNames = JSON.parse(savedNamesStr);
}
} catch (e) { /* ignore parse errors */ }

let formContent = '';
uniqueKeys.sort().forEach(key => {
const currentName = savedNames[key] || key;
formContent += `
<label for="name-${key.replace(/\s/g, '_')}">${key}</label>
<input type="text" id="name-${key.replace(/\s/g, '_')}" name="${key}" value="${currentName}" placeholder="${key}">
`;
});

let existingButton = periodNamesForm.querySelector('.save-settings-button');
let buttonHTML = existingButton ? existingButton.outerHTML : '<button type="submit" class="save-settings-button">Save Period Names</button>';

periodNamesForm.innerHTML = formContent + buttonHTML;

periodNamesForm.removeEventListener('submit', handlePeriodFormSubmit);
periodNamesForm.addEventListener('submit', handlePeriodFormSubmit);
};

const handlePeriodFormSubmit = (e) => {
e.preventDefault();
const formData = new FormData(periodNamesForm);
const customNames = {};
const defaultKeys = getUniquePeriodKeys();

for (const [originalKey, customName] of formData.entries()) {
const trimmedName = customName.trim();
if (defaultKeys.includes(originalKey) && trimmedName.length > 0) {
if (trimmedName !== originalKey) {
customNames[originalKey] = trimmedName;
}
}
}

try {
localStorage.setItem(NAMES_STORAGE_KEY, JSON.stringify(customNames));
schedules = JSON.parse(JSON.stringify(defaultSchedules));
loadPeriodNames();
updatePeriodTimer();
showMessageBox(periodMessageBox, 'Period names saved successfully! Restarting timer...', 'success');
} catch (error) {
console.error("Error saving period names to localStorage:", error);
showMessageBox(periodMessageBox, 'Failed to save period names.', 'error');
}
};

// --- LUNCH NAME UTILITIES ---

const loadLunchNames = () => {
let customLunchMap = {};
try {
const savedNamesStr = localStorage.getItem(LUNCH_STORAGE_KEY);
if (savedNamesStr) {
customLunchMap = JSON.parse(savedNamesStr);
}
} catch (e) { /* ignore parse errors */ }

for (const key in DEFAULT_LUNCH_MAP) {
const input = document.getElementById(`lunch-${key.replace(/\s/g, '_')}`);
if (input) {
input.value = customLunchMap[key] || DEFAULT_LUNCH_MAP[key];
}
}
return customLunchMap;
};

const handleLunchFormSubmit = (e) => {
e.preventDefault();
const formData = new FormData(lunchNamesForm);
const customLunchMap = {};

for (const [originalKey, customName] of formData.entries()) {
const trimmedName = customName.trim();
if (trimmedName.length > 0 && DEFAULT_LUNCH_MAP.hasOwnProperty(originalKey)) {
if (trimmedName !== DEFAULT_LUNCH_MAP[originalKey]) {
customLunchMap[originalKey] = trimmedName;
}
}
}

try {
localStorage.setItem(LUNCH_STORAGE_KEY, JSON.stringify(customLunchMap));
updateLunchDisplay();
showMessageBox(lunchMessageBox, 'Lunch periods saved successfully!', 'success');
} catch (error) {
console.error("Error saving lunch names to localStorage:", error);
showMessageBox(lunchMessageBox, 'Failed to save lunch periods.', 'error');
}
};

const updateLunchDisplay = () => {
const now = new Date();
const dayName = now.toLocaleDateString("en-US", { weekday: "long" });
const schedule = schedules[dayName] || [];
const customLunchMap = loadLunchNames();

let currentLunch = "No Scheduled Lunch Today";
let foundLunch = false;

for (let block of defaultSchedules[dayName] || []) {
const originalPeriodKey = block.period;

if (DEFAULT_LUNCH_MAP.hasOwnProperty(originalPeriodKey)) {
const lunchName = customLunchMap[originalPeriodKey] || DEFAULT_LUNCH_MAP[originalPeriodKey];
const workingBlock = schedule.find(b => b.start === block.start && b.end === block.end);

if (workingBlock) {
currentLunch = `${lunchName} (${workingBlock.start} - ${workingBlock.end})`;
foundLunch = true;
break;
}
}
}

currentLunchDisplay.innerText = foundLunch ? currentLunch : "No Scheduled Lunch Today";
}

// --- REMINDER UTILITIES (MODIFIED FOR INTERVAL CHECK) ---

const loadReminders = () => {
try {
const remindersStr = localStorage.getItem(REMINDER_STORAGE_KEY);
// We no longer filter out past reminders here, the interval checker will handle cleanup
return remindersStr ? JSON.parse(remindersStr) : [];
} catch (e) {
console.error("Error loading reminders:", e);
return [];
}
};

const saveReminders = (reminders) => {
try {
localStorage.setItem(REMINDER_STORAGE_KEY, JSON.stringify(reminders));
} catch (e) {
console.error("Error saving reminders:", e);
}
};

const deleteReminder = (id) => {
let reminders = loadReminders();
reminders = reminders.filter(r => r.id !== id);
saveReminders(reminders);
renderReminders();
showMessageBox(reminderMessageBox, 'Reminder deleted.', 'success');
};

const renderReminders = () => {
const reminders = loadReminders().sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
activeRemindersList.innerHTML = '';

if (reminders.length === 0) {
activeRemindersList.innerHTML = `<li style="font-size: 14px; color: var(--text-color); opacity: 0.7; border-bottom: none;">No active reminders set.</li>`;
return;
}

reminders.forEach(r => {
// Since we now store the local time string (YYYY-MM-DDTHH:MM:SS), this will correctly parse it as local time.
const reminderTime = new Date(r.timestamp);
const item = document.createElement('li');
const dateStr = reminderTime.toLocaleDateString();
const timeStr = reminderTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

item.innerHTML = `
<span><strong>${r.title}</strong><br><small style="opacity: 0.8; color: var(--accent-yellow);">${dateStr} @ ${timeStr}</small></span>
<button class="delete-reminder-button" data-id="${r.id}" style="background: var(--accent-red); color: var(--primary-bg); border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: bold;">&times; Delete</button>
`;
activeRemindersList.appendChild(item);
});

document.querySelectorAll('.delete-reminder-button').forEach(button => {
button.addEventListener('click', (e) => {
const id = e.target.getAttribute('data-id');
deleteReminder(id);
});
});
};

const handleReminderSubmit = (e) => {
e.preventDefault();
const title = document.getElementById('reminder-title').value.trim();
const date = document.getElementById('reminder-date').value;
const time = document.getElementById('reminder-time').value;

if (!title || !date || !time) {
showMessageBox(reminderMessageBox, 'Please fill out all fields.', 'error');
return;
}

// This creates the standardized local time string (e.g., "2025-10-02T09:45:00")
const datetimeString = `${date}T${time}:00`;

// We create a Date object *only* for validation against the current time.
const reminderTime = new Date(datetimeString);
const now = new Date();

if (reminderTime.getTime() <= now.getTime()) {
showMessageBox(reminderMessageBox, 'Reminder time must be in the future.', 'error');
return;
}

const newReminder = {
id: Date.now().toString(),
title: title,
// CRITICAL FIX: We save the local time string directly, not the UTC-converted ISO string.
timestamp: datetimeString,
};

let reminders = loadReminders();
reminders.push(newReminder);
saveReminders(reminders);

e.target.reset();
renderReminders();
showMessageBox(reminderMessageBox, 'Reminder created and scheduled!', 'success');
};

// Function to show custom slide-in notification
const showInAppNotification = (title, body) => {
console.log(`[Notification Fired] Title: ${title}, Body: ${body}`); // Debugging log

const notificationTitle = inAppNotification.querySelector('h4');
const notificationMessage = document.getElementById('notification-message');

// Ensure we don't try to show it if it's currently showing
inAppNotification.classList.remove('show');

// Slight delay to reset the animation state before showing
setTimeout(() => {
notificationTitle.innerHTML = `<span>üîî</span> ${title}`;
notificationMessage.textContent = body;

// Show the notification
inAppNotification.classList.add('show');

// Auto-hide after 5 seconds
setTimeout(() => {
inAppNotification.classList.remove('show');
}, 5000);
}, 50); // Small delay to force the CSS transition to re-fire
}


// Function to check reminders in the 1-second interval
const checkIntervalReminders = () => {
let reminders = loadReminders();
// Get current time in milliseconds (based on the user's clock/timezone)
const now = new Date().getTime();
let remindersToKeep = [];
let firedCount = 0;

reminders.forEach(r => {
// Parse the stored local time string into a Date object (which respects the user's timezone)
const reminderTime = new Date(r.timestamp).getTime();

// Check if the reminder time is in the past (or within the next second)
if (reminderTime <= now + 1000) {
console.log(`[Interval Checker] Reminder FIRED: "${r.title}"`);
showInAppNotification("Reminder", r.title);
firedCount++;
} else {
// Keep active future reminders
remindersToKeep.push(r);
}
});

// If any reminder fired, save the reduced list and re-render
if (reminders.length !== remindersToKeep.length) {
saveReminders(remindersToKeep);
renderReminders();
}
};


// --- TIMER AND DISPLAY UTILITIES ---

const formatTimeLeft = (totalSeconds) => {
if (totalSeconds < 0) return "0s";
const hours = Math.floor(totalSeconds / 3600);
const minutes = Math.floor((totalSeconds % 3600) / 60);
const seconds = totalSeconds % 60;
let parts = [];
if (hours > 0) parts.push(`${hours}h`);
if (minutes > 0) parts.push(`${minutes}m`);
if (totalSeconds >= 0) {
parts.push(`${seconds}s`);
}
return parts.join(" ");
};
const timeToMinutes = (timeStr) => {
const parts = timeStr.split(":").map(Number);
return parts[0] * 60 + parts[1];
};

const calculateWeekendTarget = (now) => {
let nextDay = new Date(now);
let dayOfWeek = nextDay.getDay();
let daysUntilMonday = (8 - dayOfWeek) % 7;
if (daysUntilMonday === 0) daysUntilMonday = 7;
nextDay.setDate(nextDay.getDate() + daysUntilMonday);
nextDay.setHours(7, 20, 0, 0);
return nextDay;
};

const updateInfoSection = () => {
const now = new Date();
const timeStr = now.toLocaleTimeString("en-US", { hour: '2-digit', minute: '2-digit', second: '2-digit' });
const dateStr = (now.getMonth() + 1).toString().padStart(2, '0') + '/' + now.getDate().toString().padStart(2, '0') + '/' + now.getFullYear();
const dayName = now.toLocaleDateString("en-US", { weekday: "long" });
const schedule = schedules[dayName] || [];
const currentMinutes = now.getHours() * 60 + now.getMinutes() + now.getSeconds() / 60;

let parity = "Unknown Schedule";

if (schedule.length > 0) {
const firstStartMinutes = timeToMinutes(schedule[0].start);
const lastEndMinutes = timeToMinutes(schedule[schedule.length - 1].end);
let inSession = false;
for (let block of schedule) {
const startMinutes = timeToMinutes(block.start);
const endMinutes = timeToMinutes(block.end);

if (currentMinutes >= startMinutes && currentMinutes < endMinutes) {
parity = dayName + " Schedule";
inSession = true;
break;
}
}
if (!inSession) {
if (currentMinutes < firstStartMinutes) {
parity = "Before School";
} else if (currentMinutes >= lastEndMinutes) {
parity = "After School";
} else {
parity = "Intermission";
}
}
} else {
parity = "Weekend / No School";
}
const infoEl = document.getElementById("info-section");
if (infoEl) {
infoEl.innerText = `Time: ${timeStr} | Date: ${dateStr} | ${parity}`;
}
};

const updatePeriodTimer = () => {
const now = new Date();
const dayName = now.toLocaleDateString("en-US", { weekday: "long" });
const schedule = schedules[dayName] || [];
const currentMinutes = now.getHours() * 60 + now.getMinutes();
let currentPeriod = "No Class";
let totalSecondsLeft = -1;

for (let block of schedule) {
const startMinutes = timeToMinutes(block.start);
const endMinutes = timeToMinutes(block.end);
if (currentMinutes >= startMinutes && currentMinutes < endMinutes) {
currentPeriod = block.period;
totalSecondsLeft = (endMinutes * 60) - (currentMinutes * 60) - now.getSeconds();
break;
}
}

if (totalSecondsLeft === -1) {
let nextTarget = null;

if (schedule.length > 0) {
const firstStartMinutes = timeToMinutes(schedule[0].start);
const lastEndMinutes = timeToMinutes(schedule[schedule.length - 1].end);
if (currentMinutes < firstStartMinutes) {
nextTarget = new Date(now);
const firstPeriodStart = schedule[0].start.split(":").map(Number);
nextTarget.setHours(firstPeriodStart[0], firstPeriodStart[1], 0, 0);
currentPeriod = "Before School";
} else if (currentMinutes >= lastEndMinutes) {
currentPeriod = "After School";
let nextDay = new Date(now);
nextDay.setDate(now.getDate() + 1);
while (nextDay.getDay() === 0 || nextDay.getDay() === 6) { nextDay.setDate(nextDay.getDate() + 1); }
nextTarget = nextDay;
nextTarget.setHours(7, 20, 0, 0);
} else {
for (let i = 0; i < schedule.length; i++) {
const block = schedule[i];
const startMinutes = timeToMinutes(block.start);
if (currentMinutes < startMinutes) {
nextTarget = new Date(now);
const blockStart = block.start.split(":").map(Number);
nextTarget.setHours(blockStart[0], blockStart[1], 0, 0);
currentPeriod = `Next: ${block.period}`;
break;
}
}
}
} else {
currentPeriod = "Weekend/Break";
nextTarget = calculateWeekendTarget(now);
}

if (nextTarget) {
totalSecondsLeft = Math.floor((nextTarget.getTime() - now.getTime()) / 1000);
if (totalSecondsLeft < 0) totalSecondsLeft = 0;
}
}

let timeLeft = formatTimeLeft(totalSecondsLeft);
const timerContainer = document.getElementById("period-timer");
let timerTextSpan = document.getElementById("timer-text");

if (!timerTextSpan) {
timerContainer.innerHTML = `${currentPeriod} ‚Äì <span id="timer-text" class="timer-text">${timeLeft} left</span>`;
timerTextSpan = document.getElementById("timer-text");
} else {
timerContainer.firstChild.nodeValue = `${currentPeriod} ‚Äì `;
timerTextSpan.innerText = `${timeLeft} left`;
}

timerTextSpan.classList.remove('timer-active');
timerTextSpan.style.color = 'var(--text-color)';

if (totalSecondsLeft > 0 && currentPeriod !== "After School" && currentPeriod !== "Weekend/Break") {
timerTextSpan.classList.add('timer-active');
const fifteenMinutesInSeconds = 15 * 60;

if (totalSecondsLeft > fifteenMinutesInSeconds) {
timerTextSpan.style.color = 'var(--accent-green)';
} else {
timerTextSpan.style.color = 'var(--accent-red)';
}
}
updateInfoSection();
// IMPORTANT: Call the new check function every second
checkIntervalReminders();
};

const showReminderModal = () => {
renderReminders();
reminderModal.classList.add('show');
document.body.style.overflow = 'hidden';
};
const hideReminderModal = () => {
reminderModal.classList.remove('show');
document.body.style.overflow = '';
};


// --- NEW: Profile Uploader Functions ---

/**
 * Initializes the profile uploader state when the account modal is opened.
 */
function initProfileUploader() {
    if (!currentUser) return; // Should be logged in to see modal

    // Select elements *inside* the modal
    fileInput = document.getElementById('fileInput');
    cropperWrapper = document.getElementById('cropper-wrapper');
    cropperImg = document.getElementById('cropper-image');
    uploadBtn = document.getElementById('uploadBtn');
    currentAvatar = document.getElementById('current-avatar');
    noAvatarText = document.getElementById('no-avatar-text');
    status = document.getElementById('status');

    // Detach old listeners to prevent duplicates
    fileInput.removeEventListener('change', handleFileChange);
    uploadBtn.removeEventListener('click', handleUpload);
    
    // Attach new listeners
    fileInput.addEventListener('change', handleFileChange);
    uploadBtn.addEventListener('click', handleUpload);

    const avatarUrl = currentUser.user_metadata?.avatar_url;

    if (avatarUrl) {
        currentAvatar.src = avatarUrl;
        currentAvatar.style.display = '';
        noAvatarText.style.display = 'none';

        // Parse the storage path from the public URL
        try {
            const url = new URL(avatarUrl);
            const parts = url.pathname.split('/');
            const idx = parts.indexOf('profile-pictures'); // Bucket name
            if (idx !== -1) {
                oldAvatarPath = parts.slice(idx + 1).join('/'); 
            } else {
                oldAvatarPath = null;
            }
        } catch (e) {
            oldAvatarPath = null;
        }
    } else {
        currentAvatar.style.display = 'none';
        noAvatarText.style.display = '';
        oldAvatarPath = null;
    }

    // Reset cropper state
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
    cropperWrapper.style.display = 'none';
    fileInput.value = "";
    uploadBtn.disabled = true;
    if (status) status.textContent = "";
}

/**
 * Handles the file input change event to load the cropper.
 */
function handleFileChange(e) {
    const file = e.target.files[0];
    if (!file) {
        cropperWrapper.style.display = 'none';
        uploadBtn.disabled = true;
        return;
    }
    if (!file.type.startsWith("image/")) {
        status.textContent = "Only image files are allowed.";
        fileInput.value = "";
        cropperWrapper.style.display = 'none';
        uploadBtn.disabled = true;
        return;
    }
    if (file.size > 5 * 1024 * 1024) { // 5MB limit
        status.textContent = "File too large (max 5 MB).";
        fileInput.value = "";
        cropperWrapper.style.display = 'none';
        uploadBtn.disabled = true;
        return;
    }
    status.textContent = "";

    const url = URL.createObjectURL(file);
    cropperImg.src = url;
    cropperWrapper.style.display = '';
    uploadBtn.disabled = false;

    cropperImg.onload = () => {
        if (cropper) cropper.destroy();
        cropper = new Cropper(cropperImg, {
            aspectRatio: 1,
            viewMode: 1,
            dragMode: 'move',
            background: false,
            guides: false,
            autoCropArea: 1,
            cropBoxResizable: false,
            cropBoxMovable: false,
            movable: true,
            zoomable: true,
            minContainerWidth: 260,
            minContainerHeight: 260,
        });
    };
}

/**
 * Handles the upload button click event.
 */
async function handleUpload() {
    if (!cropper || !currentUser) return;
    status.textContent = "Processing image...";
    uploadBtn.disabled = true;

    cropper.getCroppedCanvas({ width: 300, height: 300, imageSmoothingQuality: 'high' })
        .toBlob(async (blob) => {
            if (!blob) {
                status.textContent = "Failed to crop image.";
                uploadBtn.disabled = false;
                return;
            }

            // 1. Delete old avatar
            if (oldAvatarPath) {
                try {
                    const { error: removeError } = await supabaseClient.storage
                        .from("profile-pictures")
                        .remove([oldAvatarPath]);
                    if (removeError) {
                        console.warn("Failed to delete old avatar:", removeError.message);
                    }
                } catch (err) {
                    console.warn("Error while deleting old avatar:", err);
                }
            }

            // 2. Upload new avatar
            const fileName = `profile-${currentUser.id}-${Date.now()}.png`;
            status.textContent = "Uploading...";
            const { data: uploadData, error: uploadError } = await supabaseClient.storage
                .from("profile-pictures")
                .upload(fileName, blob, { upsert: true });

            if (uploadError) {
                status.textContent = "Upload failed: " + uploadError.message;
                uploadBtn.disabled = false;
                return;
            }

            // 3. Get public URL
            const { data: publicUrlData } = supabaseClient.storage
                .from("profile-pictures")
                .getPublicUrl(fileName);

            const publicUrl = publicUrlData?.publicUrl;
            if (!publicUrl) {
                status.textContent = "Could not retrieve image URL.";
                uploadBtn.disabled = false;
                return;
            }

            // 4. Save to auth metadata (this updates what header-profile-picture reads)
            const { data: authUpdateData, error: authUpdateError } = await supabaseClient.auth.updateUser({
                data: { avatar_url: publicUrl }
            });
            
            if(authUpdateError) {
                    status.textContent = "Upload succeeded, but failed to update auth user: " + authUpdateError.message;
                    uploadBtn.disabled = false;
                    return;
            }
            
            // 5. Save to "profiles" table (to keep in sync)
            const { error: profileUpdateError } = await supabaseClient
                .from("profiles") // Using "profiles" table from ConnectIndex.html
                .update({ avatar_url: publicUrl }) // Assuming it has an 'avatar_url' column
                .eq("id", currentUser.id);

            if (profileUpdateError) {
                status.textContent = "Auth updated, but profile table save failed.";
                console.warn("Profile table update error:", profileUpdateError.message);
                // Not fatal, as the auth user is updated
            } else {
                status.textContent = "Profile picture updated!";
            }

            // 6. Update UI
            currentAvatar.src = publicUrl;
            currentAvatar.style.display = '';
            noAvatarText.style.display = 'none';
            cropperWrapper.style.display = 'none';
            fileInput.value = "";
            uploadBtn.disabled = true;

            oldAvatarPath = fileName; // Cache new path
            
            // Manually update the global currentUser object and header image
            if (authUpdateData.user) {
                currentUser = authUpdateData.user;
            }
            headerProfilePicture.src = publicUrl;

        }, "image/png", 0.95);
}


// --- MODIFIED: Modal Show/Hide Functions ---

const showAccountModal = () => {
    // Check if user is logged in
    if (!currentUser) {
        alert("Please log in to manage your account.");
        return;
    }
    accountModal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // NEW: Initialize the profile picture uploader logic
    initProfileUploader(); 
};

const hideAccountModal = () => {
    accountModal.classList.remove('show');
    document.body.style.overflow = '';
    
    // NEW: Destroy cropper instance to free resources
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
};

const showDisplayModal = () => {
displayModal.classList.add('show');
document.body.style.overflow = 'hidden';
};
const hideDisplayModal = () => {
displayModal.classList.remove('show');
document.body.style.overflow = '';
};


// --- DOM READY AND LISTENERS ---
document.addEventListener('DOMContentLoaded', () => {

// --- NEW: Load user session ---
loadUserSession();

// 0. Load Custom Names and Populate Forms
loadPeriodNames();
populatePeriodForm();
loadLunchNames();
lunchNamesForm.addEventListener('submit', handleLunchFormSubmit);

// 1. Load Theme Preference
loadModePreference();

// 1.5. Load and apply display settings
const displaySettings = loadDisplaySettings();
applyDisplaySettings(displaySettings);
document.getElementById('font-size').value = displaySettings.fontSize || '16px';
document.getElementById('font-color').value = displaySettings.fontColor || '#f8f9fa';

// 2. Attach theme-related event listeners
darkModeButton.addEventListener('click', () => saveModePreference('dark'));
lightModeButton.addEventListener('click', () => saveModePreference('light'));

// 3. Start the timer loop and lunch display update
updatePeriodTimer();
updateLunchDisplay();
// The main interval now also runs the reminder check
setInterval(() => {
updatePeriodTimer();
updateLunchDisplay();
}, 1000);

// Function to fetch and display announcement in banner
const fetchAnnouncementForBanner = async () => {
  try {
    const response = await fetch('http://localhost:3000/announcement');
    const data = await response.json();
    const announcementBar = document.getElementById('announcement-bar');
    announcementBar.textContent = data.announcement || 'No current announcement.';
    announcementBar.style.display = 'block';
    // Hide after 35 seconds
    setTimeout(() => {
      announcementBar.style.display = 'none';
    }, 35000);
  } catch (error) {
    console.error('Error fetching announcement for banner:', error);
    const announcementBar = document.getElementById('announcement-bar');
    announcementBar.textContent = 'Unable to load announcement.';
    announcementBar.style.display = 'block';
    setTimeout(() => {
      announcementBar.style.display = 'none';
    }, 35000);
  }
};

// 4. Tab Switching
document.querySelectorAll(".left-box button").forEach(button => {
button.addEventListener("click", () => {
const target = button.getAttribute("data-tab");
document.querySelectorAll(".left-box button").forEach(btn => btn.classList.remove("active"));
button.classList.add("active");
// Hide announcement bar when switching tabs
document.getElementById('announcement-bar').style.display = 'none';
tabs.forEach(tab => {
tab.classList.remove("active");
if (tab.id === target) {
tab.classList.add("active");
if (tab.id === 'weather') {
fetchWeather();
}
if (tab.id === 'news') {
renderNews();
fetchAnnouncementForBanner();
}
if (tab.id === 'polls') {
renderPolls();
}
}
});
});
});
if (homeButton) homeButton.classList.add("active");

// 4.5. Close Tab Button Functionality
document.querySelectorAll('.close-tab-button').forEach(button => {
    button.addEventListener('click', () => {
        // Switch to home tab
        document.querySelectorAll(".left-box button").forEach(btn => btn.classList.remove("active"));
        const homeBtn = document.querySelector(".left-box button[data-tab='home']");
        homeBtn.classList.add("active");
        tabs.forEach(tab => {
            tab.classList.remove("active");
            if (tab.id === 'home') {
                tab.classList.add("active");
            }
        });
    });
});

// 5. Header Scroll Hide/Show
let lastScrollY = window.scrollY;
const header = document.querySelector('.header');
const headerHeight = header.offsetHeight;
window.addEventListener('scroll', () => {
const currentScrollY = window.scrollY;
if (currentScrollY > lastScrollY && currentScrollY > headerHeight) {
header.style.top = `-${headerHeight}px`;
} else {
header.style.top = '0';
}
lastScrollY = currentScrollY;
});

// 6. Image Preview (Placeholder for lunch items)
const fetchImage = async (food) => {
return `https://placehold.co/300x300/4cc9f0/1a1b2f?text=${encodeURIComponent(food)}`;
};
const preview = document.getElementById("preview");
document.querySelectorAll(".info p").forEach(item => {
item.addEventListener("mouseenter", async (e) => {
const food = e.target.getAttribute("data-food");
const imgUrl = await fetchImage(food);
preview.src = imgUrl;
preview.style.display = "block";
});
item.addEventListener("mousemove", (e) => {
preview.style.left = (e.pageX + 20) + "px";
preview.style.top = (e.pageY + 20) + "px";
});
item.addEventListener("mouseleave", () => {
preview.style.display = "none";
});
});

// 7. Modal Logic

// 8. Reminder Maker Logic
// Click handler for the card itself (opens modal)
if (notificationsCard) notificationsCard.addEventListener('click', showReminderModal);
// Click handler for the TEST button (fires animation)
if (testNotificationButton) {
testNotificationButton.addEventListener('click', (e) => {
e.stopPropagation(); // Stop the event from propagating to the card and opening the modal
showInAppNotification("Test Notification", "This should slide in smoothly!");
});
}
if (closeReminderModalButton) closeReminderModalButton.addEventListener('click', hideReminderModal);
if (reminderModal) reminderModal.addEventListener('click', (e) => {
if (e.target === reminderModal) { hideReminderModal(); }
});
if (reminderForm) reminderForm.addEventListener('submit', handleReminderSubmit);

// 9. Account Modal Logic (MODIFIED)
if (accountCard) accountCard.addEventListener('click', showAccountModal); // Uses new function
if (closeAccountModalButton) closeAccountModalButton.addEventListener('click', hideAccountModal); // Uses new function
if (accountModal) accountModal.addEventListener('click', (e) => {
if (e.target === accountModal) { hideAccountModal(); } // Uses new function
});
if (accountForm) accountForm.addEventListener('submit', (e) => {
e.preventDefault();
// This form now only saves username/password
// The profile picture is saved by its own button
// Placeholder: show confirmation message
confirmationMessage.style.display = 'block';
confirmationMessage.textContent = 'Username/Password save logic goes here!';
confirmationMessage.style.color = 'var(--accent-green)';
setTimeout(() => {
confirmationMessage.style.display = 'none';
}, 3000);
});

// 10. Display Modal Logic
if (displayCard) displayCard.addEventListener('click', showDisplayModal);
if (closeDisplayModalButton) closeDisplayModalButton.addEventListener('click', hideDisplayModal);
if (displayModal) displayModal.addEventListener('click', (e) => {
if (e.target === displayModal) { hideDisplayModal(); }
});
if (resetDisplayButton) resetDisplayButton.addEventListener('click', resetDisplaySettings);

// 11. Clubs Modal Logic
if (clubsCard) clubsCard.addEventListener('click', showClubsModal);
if (closeClubsModalButton) closeClubsModalButton.addEventListener('click', hideClubsModal);
if (clubsModal) clubsModal.addEventListener('click', (e) => {
if (e.target === clubsModal) { hideClubsModal(); }
});

// 12. Trivia Modal Logic
if (triviaCard) triviaCard.addEventListener('click', showTriviaModal);
if (closeTriviaModalButton) closeTriviaModalButton.addEventListener('click', hideTriviaModal);
if (triviaModal) triviaModal.addEventListener('click', (e) => {
if (e.target === triviaModal) { hideTriviaModal(); }
});

// 13. Puzzle Modal Logic
if (puzzleCard) puzzleCard.addEventListener('click', showPuzzleModal);
if (closePuzzleModalButton) closePuzzleModalButton.addEventListener('click', hidePuzzleModal);
if (puzzleModal) puzzleModal.addEventListener('click', (e) => {
if (e.target === puzzleModal) { hidePuzzleModal(); }
});
// 14. Calendar Modal Logic
if (eventsCard) eventsCard.addEventListener('click', showCalendarModal);
if (closeCalendarModalButton) closeCalendarModalButton.addEventListener('click', hideCalendarModal);
if (calendarModal) calendarModal.addEventListener('click', (e) => {
if (e.target === calendarModal) { hideCalendarModal(); }
});

// 15. Study Timer Modal Logic
if (studyTimerCard) studyTimerCard.addEventListener('click', showStudyTimerModal);
if (closeStudyTimerModalButton) closeStudyTimerModalButton.addEventListener('click', hideStudyTimerModal);
if (studyTimerModal) studyTimerModal.addEventListener('click', (e) => {
  if (e.target === studyTimerModal) { hideStudyTimerModal(); }
});
startStudyTimerButton.addEventListener('click', startStudyTimer);
pauseStudyTimerButton.addEventListener('click', pauseStudyTimer);
resetStudyTimerButton.addEventListener('click', resetStudyTimer);

// Initially disable pause and reset
pauseStudyTimerButton.disabled = true;
resetStudyTimerButton.disabled = true;

// Font size change
document.getElementById('font-size').addEventListener('change', (e) => {
const settings = loadDisplaySettings();
settings.fontSize = e.target.value;
saveDisplaySettings(settings);
applyDisplaySettings(settings);
showMessageBox(document.getElementById('display-message'), 'Font size updated!', 'success');
});

// Font color change
document.getElementById('font-color').addEventListener('change', (e) => {
const settings = loadDisplaySettings();
settings.fontColor = e.target.value;
saveDisplaySettings(settings);
applyDisplaySettings(settings);
showMessageBox(document.getElementById('display-message'), 'Font color updated!', 'success');
});

// Background image upload
document.getElementById('bg-upload').addEventListener('change', (e) => {
const file = e.target.files[0];
if (file) {
const reader = new FileReader();
reader.onload = (event) => {
const settings = loadDisplaySettings();
settings.bgImage = event.target.result;
saveDisplaySettings(settings);
applyDisplaySettings(settings);
showMessageBox(document.getElementById('display-message'), 'Background image updated!', 'success');
};
reader.readAsDataURL(file);
}
});

// --- "My Posts" Modal Listeners (Supabase) ---
if (headerProfilePicture) headerProfilePicture.addEventListener('click', showMyPostsModal);
if (closeMyPostsModalButton) closeMyPostsModalButton.addEventListener('click', hideMyPostsModal);
if (myPostsModal) myPostsModal.addEventListener('click', (e) => {
    if (e.target === myPostsModal) { hideMyPostsModal(); }
});

// --- "My Posts" Customization Listeners (Supabase) ---
if (myPostsResetButton) myPostsResetButton.addEventListener('click', resetMyPostsDisplaySettings);

if (myPostsBgColorInput) myPostsBgColorInput.addEventListener('change', (e) => {
    saveMyPostsDisplaySettings({ bg_color: e.target.value });
});

if (myPostsFontColorInput) myPostsFontColorInput.addEventListener('change', (e) => {
    saveMyPostsDisplaySettings({ font_color: e.target.value });
});

if (myPostsBgImageInput) myPostsBgImageInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file || !currentUser) return;

    const filePath = `${currentUser.id}/${Date.now()}_${file.name}`;
    showMessageBox(myPostsDisplayMessage, 'Uploading image...', 'success');

    const { error: uploadError } = await supabaseClient.storage
        .from('post_backgrounds')
        .upload(filePath, file, {
            cacheControl: '3600',
            upsert: true 
        });

    if (uploadError) {
        console.error('Error uploading image:', uploadError);
        showMessageBox(myPostsDisplayMessage, `Upload Error: ${uploadError.message}`, 'error');
        return;
    }

    const { data: urlData } = supabaseClient.storage
        .from('post_backgrounds')
        .getPublicUrl(filePath);

    if (urlData) {
        await saveMyPostsDisplaySettings({ bg_image_url: urlData.publicUrl });
    }
});

// --- NEW: Sign Out Button Listener ---
const signOutButton = document.getElementById('sign-out-button');
if (signOutButton) {
    signOutButton.addEventListener('click', handleSignOut);
}


});
</script>
<script>
let isSignedIn = false;

function handleProfileClick() {
    if (!isSignedIn) {
        alert("Redirecting to sign-in page...");
        // Redirect logic here
    } else {
        alert("Opening profile...");
        // Profile logic here
    }
}

function logout() {
    isSignedIn = false;
    alert("You have been logged out.");
    // Additional logout logic here
}

document.getElementById("minimize-btn").addEventListener("click", function() {
    const navbar = document.getElementById("navbar");
    navbar.classList.toggle("minimized");
});
</script>
<script src="wallpapers/wallpapers.js"></script>
</body>
</html>
